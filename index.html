<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>SISTEMA POSTAL DE PANAMA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        .map-title {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 4000; text-align: center; pointer-events: none; width: 90%;
        }
        .map-title h1 { 
            margin: 0; font-size: 20px; color: #2c3e50; font-weight: bold; letter-spacing: 2px;
            text-shadow: 0 0 5px white, 0 0 10px white;
        }
        .search-container {
            position: absolute; top: 10px; right: 10px; z-index: 3000;
            display: flex; background: white; padding: 5px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 260px;
        }
        input#search-input { flex: 1; border: none; padding: 8px; font-size: 16px; outline: none; width: 100%; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-nav { background-color: #3498db; color: white !important; text-decoration: none !important; padding: 8px 10px; border-radius: 5px; font-weight: bold; font-size: 11px; text-align: center; }
        .btn-ws { background-color: #25d366; color: white !important; text-decoration: none !important; padding: 8px 10px; border-radius: 5px; font-weight: bold; font-size: 11px; text-align: center; }
        .leaflet-top.leaflet-right { top: 65px !important; }
        .grid-label { font-size: 10px; font-weight: bold; color: #2980b9; pointer-events: none; text-shadow: 0 0 2px white; }
        .locate-button { background: white; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 5px; font-size: 20px; border: 2px solid rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="map-title">
    <h1>SISTEMA POSTAL DE PANAMA</h1>
</div>

<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: ADE4321">
    <button id="search-btn">IR</button>
</div>

<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
// Proyecto realizado por Raul Viquez.
const mymap = L.map('mapid', { zoomControl: true }).setView([8.98, -79.52], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 24,
    maxNativeZoom: 19
}).addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
const clickHighlightLayer = L.layerGroup().addTo(mymap);
let estafetasLayer = L.layerGroup().addTo(mymap);
let estafetaslLayer = L.layerGroup().addTo(mymap);
let estafetaspLayer = L.layerGroup().addTo(mymap);
let rawGeoData = null;

const GRID7_LAT = 0.00035; 
const GRID7_LON = 0.00045;
const MICRO_LAT_DIV = GRID7_LAT / 10;
const MICRO_LON_DIV = GRID7_LON / 23;

function abrirNavegacion(lat, lon) {
    window.open("https://www.google.com/maps?q=" + lat + "," + lon, '_blank');
}

function compartirWhatsApp(lat, lon, codigo) {
    const msg = "Mi Direccion Postal en Panama es: " + codigo + "\n\nVer en mapa: https://www.google.com/maps?q=" + lat + "," + lon;
    window.open("https://wa.me/?text=" + encodeURIComponent(msg), '_blank');
}

function generarCOD7(lat, lon) {
    const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    const xNorm = (lon - (-83.05)) / (-77.15 - (-83.05));
    if (xNorm < 0 || xNorm >= 1) return "0000000";
    let v = Math.floor(xNorm * 13824);
    let lll = "";
    for (let i = 0; i < 3; i++) { lll = ALFABETO[v % 24] + lll; v = Math.floor(v / 24); }
    const yNorm = (lat - 7.0) / (10.0 - 7.0);
    const nnnn = Math.floor(yNorm * 10000).toString().padStart(4, "0");
    return lll + nnnn;
}

function generarMicroLN(lat, lon) {
    const LETRAS = "ABCDEFGHJKMNPQRSTUVWXYZ".split("");
    const xRel = Math.floor((((lon % GRID7_LON) + GRID7_LON) % GRID7_LON) / MICRO_LON_DIV);
    const yRel = Math.floor((((lat % GRID7_LAT) + GRID7_LAT) % GRID7_LAT) / MICRO_LAT_DIV);
    const pX = [15, 3, 20, 7, 0, 12, 18, 5, 22, 9, 2, 14, 1, 19, 6, 11, 21, 4, 16, 8, 17, 10, 13];
    const pY = [9, 3, 0, 6, 1, 7, 4, 8, 2, 5];
    return LETRAS[pX[Math.abs(xRel) % 23]] + pY[Math.abs(yRel) % 10];
}

$.getJSON("estafetas.geojson", function(data) {
    rawGeoData = data;
    L.geoJSON(data, { style: { color: "#2c3e50", weight: 2, fillOpacity: 0.1 } }).addTo(estafetasLayer);
});
$.getJSON("estafetasl.geojson", data => L.geoJSON(data, { style: { color: "#e74c3c", weight: 3 } }).addTo(estafetaslLayer));
$.getJSON("estafetasp.geojson", data => L.geoJSON(data, {
    pointToLayer: (f, ll) => L.circleMarker(ll, {radius:8, color:"#27ae60", fillColor:"#2ecc71", fillOpacity:1}),
    onEachFeature: (f, l) => {
        let n = f.properties.ESTAF_NAME || "Estafeta";
        l.bindPopup("<div style='text-align:center;'><b>ESTAFETA:</b><br>" + n + "<br><a href='#' class='btn-nav' style='display:inline-block;margin-top:5px' onclick='abrirNavegacion(" + l.getLatLng().lat + "," + l.getLatLng().lng + ")'>IR</a></div>");
    }
}).addTo(estafetaspLayer));

L.control.layers(null, { "Zonas": estafetasLayer, "Rutas": estafetaslLayer, "Estafetas": estafetaspLayer }, {collapsed:false, position:'topright'}).addTo(mymap);

mymap.on("click", function (e) {
    if (e.originalEvent._leaf_handled) return; 
    clickHighlightLayer.clearLayers();
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    let vm = null;
    if (rawGeoData) {
        const hit = leafletPip.pointInLayer([lon, lat], L.geoJSON(rawGeoData));
        if (hit.length > 0) vm = hit[0].feature.properties.VM_LEVEL;
    }
    if (!vm) {
        L.popup().setLatLng(e.latlng).setContent("<div style='text-align:center;color:#c0392b'><b>ZONA NO DEFINIDA</b></div>").openOn(mymap);
        return;
    }
    const zoom = mymap.getZoom();
    const cod7 = generarCOD7(lat, lon);
    let codFinal = "";
    if (zoom < 21) {
        codFinal = vm + "-" + cod7;
    } else {
        const snapLat = Math.floor(lat / MICRO_LAT_DIV) * MICRO_LAT_DIV;
        const snapLon = Math.floor(lon / MICRO_LON_DIV) * MICRO_LON_DIV;
        L.rectangle([[snapLat, snapLon], [snapLat + MICRO_LAT_DIV, snapLon + MICRO_LON_DIV]], {
            color: "#d35400", weight: 2, fillOpacity: 0.4, interactive: false
        }).addTo(clickHighlightLayer);
        codFinal = vm + "-" + cod7 + "-" + generarMicroLN(lat, lon);
    }
    const contenido = "<div style='text-align:center; min-width:180px; padding-top:10px;'>" +
                "<b style='font-size:10px; color:#7f8c8d;'>DIRECCION POSTAL</b><br>" +
                "<span style='font-size:18px; font-weight:bold; color:#d35400;'>" + codFinal + "</span><br>" +
                "<div style='margin-top:10px; display: flex; gap: 5px; justify-content: center;'>" +
                    "<a href='#' class='btn-nav' style='flex:1' onclick='abrirNavegacion(" + lat + "," + lon + ")'>IR MAPA</a>" +
                    "<a href='#' class='btn-ws' style='flex:1' onclick='compartirWhatsApp(" + lat + "," + lon + ",\"" + codFinal + "\")'>WHATSAPP</a>" +
                "</div></div>";
    L.popup({ offset: [0, -30], autoPan: true }).setLatLng(e.latlng).setContent(contenido).openOn(mymap);
});

document.getElementById('search-btn').onclick = function() {
    const s = document.getElementById('search-input').value.trim().toUpperCase();
    const code = s.includes('-') ? s.split('-')[1] : s;
    if (!/^[A-Z]{3}\d{4}$/.test(code)) { alert("Formato: ABC1234"); return; }
    const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    let v_x = 0; for(let i=0;i<3;i++){ v_x = v_x*24+ALFABETO.indexOf(code[i]); }
    const lon = ((v_x + 0.5)/13824)*(-77.15 - (-83.05)) + (-83.05);
    const lat = ((parseInt(code.substring(3)) + 0.5)/10000)*(10-7)+7;
    mymap.setView([lat, lon], 21);
    L.marker([lat, lon]).addTo(clickHighlightLayer).bindPopup("<b>Busqueda: " + s + "</b>").openPopup();
};

const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', 'locate-button', container);
        button.innerHTML = 'GPS';
        L.DomEvent.on(button, 'click', e => { 
            L.DomEvent.stopPropagation(e); 
            mymap.locate({enableHighAccuracy: true, setView: true, maxZoom: 21}); 
        });
        return container;
    }
});
mymap.addControl(new LocateControl());

function updateGrid() {
    gridLayer.clearLayers();
    if (mymap.getZoom() < 17) return;
    const b = mymap.getBounds();
    for (let x = Math.floor(b.getWest()/GRID7_LON)*GRID7_LON; x <= b.getEast(); x += GRID7_LON) {
        for (let y = Math.floor(b.getSouth()/GRID7_LAT)*GRID7_LAT; y <= b.getNorth(); y += GRID7_LAT) {
            const lat = y+GRID7_LAT/2, lon = x+GRID7_LON/2;
            const code = generarCOD7(lat, lon);
            L.rectangle([[y,x],[y+GRID7_LAT,x+GRID7_LON]], {color:"#3498db", weight:0.4, fillOpacity:0.03, interactive:false}).addTo(gridLayer);
            if (mymap.getZoom()>=18 && mymap.getZoom()<21) L.marker([lat, lon], {icon:L.divIcon({className:'grid-label', html:code, iconSize:[60,20]}), interactive:false}).addTo(gridLayer);
        }
    }
}
mymap.on('moveend zoomend', updateGrid);
</script>
</body>
</html>
