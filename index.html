<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM츼 - RESOLUCI칍N NANO</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 20px; color: #2c3e50; font-weight: bold; text-shadow: 0 0 5px white; }
        .search-container { position: absolute; top: 10px; right: 10px; z-index: 3000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 260px; }
        input#search-input { flex: 1; border: none; padding: 8px; font-size: 16px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .btn-nav { display: inline-block; margin-top: 10px; padding: 8px 15px; background-color: #3498db; color: white !important; text-decoration: none !important; border-radius: 5px; font-weight: bold; font-size: 12px; }
        
        /* Estilo de la rejilla corregido para visibilidad */
        .grid-label { font-size: 10px; font-weight: bold; color: #2980b9; pointer-events: none; text-shadow: 0 0 3px white; text-align: center; }
        .leaflet-top.leaflet-right { top: 65px !important; }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM츼</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="A6199-TB259-H4">
    <button id="search-btn">IR</button>
</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid', { zoomControl: true }).setView([8.98, -79.52], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
let zonasLayer = L.layerGroup().addTo(mymap);
let rutasLayer = L.layerGroup().addTo(mymap);
let estafetasLayer = L.layerGroup().addTo(mymap);
let rawGeoData = null;

const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ"; 

// --- L칍GICA DE GEOMETR칈A JER츼RQUICA ---
function getHierarchicalCode(lat, lon, macroBounds) {
    const sw = macroBounds.getSouthWest();
    const ne = macroBounds.getNorthEast();
    
    // 1. NIVEL MICRO (Subdivisi칩n 24x24)
    const stepX = (ne.lng - sw.lng) / 24;
    const stepY = (ne.lat - sw.lat) / 24;
    const ix = Math.floor((lon - sw.lng) / stepX);
    const iy = Math.floor((lat - sw.lat) / stepY);

    // 2. NIVEL NANO (Sub-subdivisi칩n 10x10 dentro del Micro)
    const microSW_lng = sw.lng + (ix * stepX);
    const microSW_lat = sw.lat + (iy * stepY);
    const nanoStepX = stepX / 10;
    const nanoStepY = stepY / 10;
    const nix = Math.floor((lon - microSW_lng) / nanoStepX);
    const niy = Math.floor((lat - microSW_lat) / nanoStepY);

    // L칤mites para dibujo
    const microBounds = [[microSW_lat, microSW_lng], [microSW_lat + stepY, microSW_lng + stepX]];
    const nanoBounds = [
        [microSW_lat + (niy * nanoStepY), microSW_lng + (nix * nanoStepX)],
        [microSW_lat + ((niy + 1) * nanoStepY), microSW_lng + ((nix + 1) * nanoStepX)]
    ];

    // C칩digos
    const l1 = ALFABETO[ix] || "A";
    const l2 = ALFABETO[iy] || "A";
    const n1 = nix; 
    const n2 = niy;
    const n3 = Math.floor((nix + niy) / 2); // Digito de control
    
    const nanoCode = ALFABETO[nix] + niy; // Ejemplo: H4

    return {
        micro: `${l1}${l2}${n1}${n2}${n3}`,
        nano: nanoCode,
        microRect: microBounds,
        nanoRect: nanoBounds
    };
}

// --- CARGA DE DATOS ---
$.getJSON("cuadricula.geojson", function(data) {
    rawGeoData = data;
    L.geoJSON(data, {
        style: function(f) { return { color: "#2c3e50", weight: 2, fillOpacity: 0.1, interactive: true }; },
        onEachFeature: (f, l) => {
            // Manejo din치mico de interactividad
            mymap.on('zoomend', function() {
                if (mymap.getZoom() >= 16) {
                    l.setStyle({ fillOpacity: 0, weight: 0.5 });
                } else {
                    l.setStyle({ fillOpacity: 0.1, weight: 2 });
                }
            });
        }
    }).addTo(zonasLayer);
});

// Otras capas (Rutas y Estafetas)
$.getJSON("estafetasl.geojson", data => L.geoJSON(data, {style:{color:"#e74c3c", weight:3}}).addTo(rutasLayer));
$.getJSON("estafetasp.geojson", data => L.geoJSON(data, {pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:7, color:"#27ae60", fillColor:"#2ecc71", fillOpacity:1})}).addTo(estafetasLayer));

// --- CLIC EN EL MAPA ---
mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    if (!rawGeoData) return;

    const hit = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawGeoData));
    if (hit.length > 0) {
        const macroID = hit[0].feature.properties.codigo || "S/N";
        const macroBounds = L.geoJSON(hit[0].feature).getBounds();
        const data = getHierarchicalCode(e.latlng.lat, e.latlng.lng, macroBounds);

        // Dibujar el nivel Nano (el m치s peque침o)
        L.rectangle(data.nanoRect, {color: "#e67e22", weight: 2, fillOpacity: 0.4}).addTo(selectionLayer);
        // Dibujar el nivel Micro contenedor
        L.rectangle(data.microRect, {color: "#3498db", weight: 1, fillOpacity: 0.1, dashArray: "5,5"}).addTo(selectionLayer);

        L.popup().setLatLng(e.latlng).setContent(`
            <div style="text-align:center;">
                <b style="color:#7f8c8d;">C칍DIGO POSTAL COMPLETO</b><br>
                <span style="font-size:20px; font-weight:bold; color:#2c3e50;">${macroID}-${data.micro}-${data.nano}</span><br>
                <hr>
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">游늸 NAVEGAR AQU칈</button>
            </div>
        `).openOn(mymap);
    }
});

// --- REJILLA VISUAL ---
function updateGrid() {
    gridLayer.clearLayers();
    if (mymap.getZoom() < 16 || !rawGeoData) return;

    const mapBounds = mymap.getBounds();
    const hit = leafletPip.pointInLayer([mapBounds.getCenter().lng, mapBounds.getCenter().lat], L.geoJSON(rawGeoData));
    
    if (hit.length > 0) {
        const b = L.geoJSON(hit[0].feature).getBounds();
        const stepLng = (b.getEast() - b.getWest()) / 24;
        const stepLat = (b.getNorth() - b.getSouth()) / 24;

        for (let i = 0; i < 24; i++) {
            for (let j = 0; j < 24; j++) {
                let s = b.getSouth() + (j * stepLat), w = b.getWest() + (i * stepLng);
                let n = s + stepLat, e = w + stepLng;
                
                if (mapBounds.intersects([[s, w], [n, e]])) {
                    // Rejilla Micro en Azul Claro
                    L.rectangle([[s, w], [n, e]], {color: "#3498db", weight: 0.8, fillOpacity: 0, interactive: false}).addTo(gridLayer);
                    
                    if (mymap.getZoom() >= 18) {
                        const micro = getHierarchicalCode(s + stepLat/2, w + stepLng/2, b);
                        L.marker([s + stepLat/2, w + stepLng/2], {
                            icon: L.divIcon({className: 'grid-label', html: micro.micro, iconSize: [40, 10]}),
                            interactive: false
                        }).addTo(gridLayer);
                    }
                }
            }
        }
    }
}

mymap.on('moveend zoomend', updateGrid);
</script>
</body>
</html>
