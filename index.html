<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Postal Din√°mico - Panam√°</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.9/dist/leaflet-search.min.css" />

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        #map { height: 100vh; width: 100%; background: #f0f0f0; }
        
        /* Botones de Zoom Personalizados (Color Azul Postal) */
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: #0056b3 !important;
            color: white !important;
            border-bottom: 1px solid #00448a !important;
        }

        /* Estilo Bot√≥n Br√∫jula (Mi Ubicaci√≥n) */
        .locate-button {
            position: absolute; bottom: 80px; right: 10px; z-index: 1000;
            background: white; width: 40px; height: 40px; border-radius: 4px;
            cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border: none; display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: 0.3s;
        }
        .locate-button:hover { background: #f1f1f1; transform: scale(1.1); }

        /* Estilos de Popups y Botones internos */
        .btn-container { display: flex; gap: 8px; justify-content: center; margin-top: 10px; }
        .btn-maps { background: #4285F4; color: white !important; padding: 8px 12px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: bold; }
        .btn-ws { background: #25D366; color: white !important; padding: 8px 12px; border-radius: 4px; text-decoration: none; font-size: 11px; font-weight: bold; }
        .popup-title { font-weight: bold; display: block; margin-bottom: 5px; border-bottom: 1px solid #eee; text-transform: uppercase; font-size: 12px; }
    </style>
</head>
<body>

<button class="locate-button" onclick="findMe()" title="Mi Ubicaci√≥n">üß≠</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>

<script>
    // 1. Configuraci√≥n del Mapa
    const map = L.map('map', { zoomControl: false }).setView([8.983, -79.517], 8);
    
    // Zoom en la esquina inferior derecha con color azul (v√≠a CSS)
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const claveFija = "B9EVK9";

    // Capas Base
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

    // Grupos de Capas
    const grupoZonas = L.layerGroup().addTo(map);
    const grupoRutas = L.layerGroup().addTo(map);
    const grupoEstafetas = L.layerGroup().addTo(map);
    const grupoMiUbicacion = L.layerGroup().addTo(map);

    // --- CARGA DE ZONAS (Pol√≠gonos) ---
    fetch('estafetas.geojson').then(res => res.json()).then(data => {
        L.geoJSON(data, {
            style: { color: "#555", weight: 1, fillOpacity: 0.1 },
            onEachFeature: function(feature, layer) {
                const vm = feature.properties.VM_LEVEL || "0000";
                const fullCode = `${vm}-${claveFija}`;
                const center = layer.getBounds().getCenter();
                layer.bindPopup(`
                    <div style="text-align:center;">
                        <span class="popup-title" style="color:#e67e22;">C√ìDIGO POSTAL</span>
                        <b style="font-size:16px;">${fullCode}</b>
                        <div class="btn-container">
                            <a href="https://www.google.com/maps?q=${center.lat},${center.lng}" target="_blank" class="btn-maps">üìç MAPS</a>
                            <a href="https://wa.me/?text=C√≥digo+Postal:+${fullCode}" target="_blank" class="btn-ws">üí¨ WS</a>
                        </div>
                    </div>`);
            }
        }).addTo(grupoZonas);
    });

    // --- CARGA DE RUTAS (L√≠neas Rojas) ---
    fetch('estafetasl.geojson').then(res => res.json()).then(data => {
        L.geoJSON(data, {
            style: { color: "#FF0000", weight: 3 },
            onEachFeature: function(feature, layer) {
                layer.bindPopup(`
                    <span class="popup-title" style="color:#d32f2f;">RUTA POSTAL</span>
                    <b>FID:</b> ${feature.properties.fid}<br>
                    <b>Ruta:</b> ${feature.properties.RUTA}<br>
                    <b>Distancia:</b> ${feature.properties.distancia} km`);
            }
        }).addTo(grupoRutas);
    });

    // --- CARGA DE ESTAFETAS (Puntos Verdes + Buscador) ---
    fetch('estafetasp.geojson').then(res => res.json()).then(data => {
        const geoEstafetas = L.geoJSON(data, {
            pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius: 7, fillColor: "#28A745", color: "#fff", weight: 2, fillOpacity: 1 }),
            onEachFeature: function(feature, layer) {
                const vm = feature.properties.VM_LEVEL || "";
                feature.properties.postal_search = `${vm}-${claveFija}`;
                layer.bindPopup(`
                    <span class="popup-title" style="color:#2e7d32;">ESTAFETAS POSTALES</span>
                    <b>Nombre:</b> ${feature.properties.ESTAF_NAME}<br>
                    <b>C√≥digo:</b> ${feature.properties.ESTAF_CODE}`);
            }
        }).addTo(grupoEstafetas);

        // Buscador arriba a la derecha
        map.addControl(new L.Control.Search({
            layer: grupoEstafetas, propertyName: 'postal_search', position: 'topright', marker: false, initial: false,
            textPlaceholder: 'üîç Buscar C√≥digo...', moveToLocation: function(latlng) { map.setView(latlng, 15); }
        }));
    });

    // --- SELECTOR DE CAPAS ---
    const overlayMaps = {
        "üìç Estafetas": grupoEstafetas,
        "üõ£Ô∏è Rutas": grupoRutas,
        "üî≤ Zonas": grupoZonas,
        "üîµ Mi Ubicaci√≥n": grupoMiUbicacion
    };
    L.control.layers({"Mapa": osm}, overlayMaps, { collapsed: false, position: 'topright' }).addTo(map);

    // --- FUNCI√ìN MI UBICACI√ìN CON BR√öJULA ---
    let markerUsuario;
    function findMe() {
        map.locate({setView: true, maxZoom: 15});
    }

    map.on('locationfound', function(e) {
        grupoMiUbicacion.clearLayers(); // Limpia ubicaci√≥n anterior
        markerUsuario = L.marker(e.latlng).bindPopup("Tu ubicaci√≥n actual").addTo(grupoMiUbicacion);
        // Asegura que la capa de ubicaci√≥n est√© encendida en el selector
        if (!map.hasLayer(grupoMiUbicacion)) { map.addLayer(grupoMiUbicacion); }
    });

    map.on('locationerror', function() { alert("Acceso a ubicaci√≥n denegado."); });

</script>
</body>
</html>
