<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL PANAM - FULL FEATURES</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        
        /* Buscador */
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; font-size: 14px; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        
        /* Controles laterales */
        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid #1a73e8; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .watermark-label-fixed { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-weight: bold; font-size: 12px;}
        
        /* Botones del Popup */
        .btn-nav, .btn-ws { display: inline-block; padding: 8px 12px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; margin: 4px 2px; border:none; cursor: pointer; }
        .btn-nav { background-color: #3498db; }
        .btn-ws { background-color: #25D366; }
        
        /* GPS Icon */
        .locate-button { width: 34px; height: 34px; line-height: 34px; text-align: center; display: block; text-decoration: none; color: black; background: white; font-size: 20px; cursor: pointer; }
        
        /* Animaci贸n de selecci贸n */
        .highlighted-polygon { animation: pulse 1.5s infinite; stroke-width: 2; }
        @keyframes pulse { 0% { fill-opacity: 0.2; stroke-opacity: 0.5; } 50% { fill-opacity: 0.6; stroke-opacity: 1; } 100% { fill-opacity: 0.2; stroke-opacity: 0.5; } }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: A6099-LA002">
    <button id="search-btn">BUSCAR</button>
</div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// Capas Organizadoras
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
let labelsEnabled = true;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";

// Matem谩ticas de precisi贸n para rejilla y b煤squeda
function getPointInGrid(coords, col, row, total) {
    const p0 = coords[0], p1 = coords[1], p2 = coords[2], p3 = coords[3];
    const tX = col / total, tY = row / total;
    const lat = (1-tY)*((1-tX)*p0[1] + tX*p1[1]) + tY*((1-tX)*p3[1] + tX*p2[1]);
    const lng = (1-tY)*((1-tX)*p0[0] + tX*p1[0]) + tY*((1-tX)*p3[0] + tX*p2[0]);
    return [lat, lng];
}

function getIndicesAt(lat, lng, feature) {
    const b = L.geoJSON(feature).getBounds();
    const x = Math.min(0.9999, Math.max(0, (lng - b.getWest()) / (b.getEast() - b.getWest())));
    const y = Math.min(0.9999, Math.max(0, (lat - b.getSouth()) / (b.getNorth() - b.getSouth())));
    return { ix: Math.floor(x * 24), iy: Math.floor(y * 24), rx: (x*24)%1, ry: (y*24)%1 };
}

// Visualizaci贸n de Rejilla y Etiquetas
function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    if (!rawCuadricula) return;
    const z = mymap.getZoom();

    rawCuadricula.features.forEach(f => {
        const bounds = L.geoJSON(f).getBounds();
        if (!mymap.getBounds().intersects(bounds)) return;
        
        if (z >= 10 && z < 14 && labelsEnabled) {
            L.marker(bounds.getCenter(), {
                icon: L.divIcon({ className: 'watermark-label-fixed', html: f.properties.codigo, iconSize:[60,20] })
            }).addTo(labelLayer);
        }

        if (z >= 14 && mymap.hasLayer(gridLayer)) {
            const coords = f.geometry.coordinates[0];
            for (let i = 0; i <= 24; i++) {
                let v = [], h = [];
                for(let j=0; j<=24; j++) {
                    v.push(getPointInGrid(coords, i, j, 24));
                    h.push(getPointInGrid(coords, j, i, 24));
                }
                L.polyline(v, {color: '#3498db', weight: 0.5, opacity: 0.3}).addTo(gridLayer);
                L.polyline(h, {color: '#3498db', weight: 0.5, opacity: 0.3}).addTo(gridLayer);
            }
        }
    });
}

// Carga de archivos
$.getJSON("cuadricula.geojson", d => { rawCuadricula = d; updateGridAndLabels(); });
$.getJSON("estafetas.geojson", d => { L.geoJSON(d, {style:{color:"#2c3e50", weight:1.5, fillOpacity:0.05}}).addTo(zonasGeoLayer); });

// EVENTO CLIC CON TODAS LAS FUNCIONALIDADES
mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    if (!rawCuadricula) return;
    
    const hC = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawCuadricula));
    if (hC.length === 0) return;

    const f = hC[0].feature;
    const coords = f.geometry.coordinates[0];
    const idx = getIndicesAt(e.latlng.lat, e.latlng.lng, f);
    const z = mymap.getZoom();

    let finalCode = f.properties.codigo;
    let titulo = "ZONA POSTAL";

    if (z >= 14) {
        const micro = `${ALFABETO[idx.ix]}${ALFABETO[idx.iy]}${idx.ix % 10}${idx.iy % 10}${Math.floor((idx.ix + idx.iy) / 5)}`;
        finalCode += `-${micro}`;
        titulo = "REA POSTAL";

        if (z < 17) {
            const mPoly = [
                getPointInGrid(coords, idx.ix, idx.iy, 24),
                getPointInGrid(coords, idx.ix+1, idx.iy, 24),
                getPointInGrid(coords, idx.ix+1, idx.iy+1, 24),
                getPointInGrid(coords, idx.ix, idx.iy+1, 24)
            ];
            L.polygon(mPoly, {color: "#1a73e8", fillColor: "#1a73e8", fillOpacity: 0.4, className: 'highlighted-polygon'}).addTo(selectionLayer);
        } else {
            const nix = Math.floor(idx.rx * 25);
            const niy = Math.floor(idx.ry * 25);
            const nano = `${ALFABETO[nix % 24]}${niy % 10}`;
            finalCode += `-${nano}`;
            titulo = "CDIGO POSTAL";
            
            const nPoly = [
                getPointInGrid(coords, idx.ix + nix/25, idx.iy + niy/25, 24),
                getPointInGrid(coords, idx.ix + (nix+1)/25, idx.iy + niy/25, 24),
                getPointInGrid(coords, idx.ix + (nix+1)/25, idx.iy + (niy+1)/25, 24),
                getPointInGrid(coords, idx.ix + nix/25, idx.iy + (niy+1)/25, 24)
            ];
            L.polygon(nPoly, {color: "#e67e22", fillColor: "#e67e22", fillOpacity: 0.6, className: 'highlighted-polygon'}).addTo(selectionLayer);
        }
    }

    const wsMsg = encodeURIComponent(` Mi c贸digo postal: ${finalCode}\nGPS: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`);
    
    L.popup().setLatLng(e.latlng).setContent(`
        <div style="text-align:center; min-width:160px;">
            <small style="color:#777; font-weight:bold;">${titulo}</small><br>
            <b style="font-size:16px; color:#2c3e50;">${finalCode}</b><br>
            <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')"> GOOGLE MAPS</button>
            <button class="btn-ws" onclick="window.open('https://wa.me/?text=${wsMsg}')"> WHATSAPP</button>
        </div>
    `).openOn(mymap);
});

// BUSCADOR INTELIGENTE (MACRO Y MICRO)
document.getElementById('search-btn').addEventListener('click', () => {
    const query = document.getElementById('search-input').value.trim().toUpperCase();
    if (!query || !rawCuadricula) return;

    const parts = query.split('-');
    const macroCode = parts[0];
    const feat = rawCuadricula.features.find(f => f.properties.codigo === macroCode);

    if (feat) {
        const bounds = L.geoJSON(feat).getBounds();
        if (parts.length > 1) {
            // Si el usuario puso un c贸digo Micro (ej: LA002), intentamos centrar ah铆
            const micro = parts[1];
            const ix = ALFABETO.indexOf(micro[0]);
            const iy = ALFABETO.indexOf(micro[1]);
            if (ix !== -1 && iy !== -1) {
                const center = getPointInGrid(feat.geometry.coordinates[0], ix + 0.5, iy + 0.5, 24);
                mymap.setView(center, 16);
                return;
            }
        }
        mymap.fitBounds(bounds);
    } else {
        alert("C贸digo no encontrado");
    }
});

// BOTN GPS
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const c = L.DomUtil.create('div', 'leaflet-bar');
        const b = L.DomUtil.create('a', 'locate-button', c);
        b.innerHTML = '';
        b.title = "Mi ubicaci贸n";
        L.DomEvent.on(b, 'click', e => { 
            L.DomEvent.stopPropagation(e); 
            mymap.locate({setView: true, maxZoom: 18}); 
        });
        return c;
    }
});
mymap.addControl(new LocateControl());

mymap.on('locationfound', e => {
    userLocationLayer.clearLayers();
    L.circle(e.latlng, {radius: e.accuracy/2, color:'#3498db'}).addTo(userLocationLayer);
    L.marker(e.latlng).addTo(userLocationLayer).bindPopup("Est谩s aqu铆").openPopup();
});

// CONTROL DE CAPAS
L.control.layers(null, {
    "Zonas": zonasGeoLayer,
    "Rejilla": gridLayer,
    "Sombreado": selectionLayer,
    "Mi GPS": userLocationLayer
}, {collapsed: false}).addTo(mymap);

$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGridAndLabels();
});

mymap.on('moveend zoomend', updateGridAndLabels);
</script>
</body>
</html>
