const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// Capas
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const cuadriculaFisicaLayer = L.layerGroup().addTo(mymap);
const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null, rawZonas = null;
let labelsEnabled = true;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
const NANO_RES = 25; 

function getPointInGrid(coords, col, row, totalCols, totalRows) {
    const p0 = coords[0], p1 = coords[1], p2 = coords[2], p3 = coords[3];
    const tX = col / totalCols, tY = row / totalRows;
    const lat = (1-tY)*((1-tX)*p0[1] + tX*p1[1]) + tY*((1-tX)*p3[1] + tX*p2[1]);
    const lng = (1-tY)*((1-tX)*p0[0] + tX*p1[0]) + tY*((1-tX)*p3[0] + tX*p2[0]);
    return [lat, lng];
}

function getHierarchicalData(lat, lng, feature) {
    const b = L.geoJSON(feature).getBounds();
    const coords = feature.geometry.coordinates[0];
    
    // C치lculo mejorado y seguro
    const pctX = (lng - b.getWest()) / (b.getEast() - b.getWest());
    const pctY = (lat - b.getSouth()) / (b.getNorth() - b.getSouth());
    
    // Asegurar que est칠 dentro de los l칤mites
    const safePctX = Math.min(0.999999, Math.max(0.000001, pctX));
    const safePctY = Math.min(0.999999, Math.max(0.000001, pctY));
    
    const ix = Math.floor(safePctX * 24);
    const iy = Math.floor(safePctY * 24);
    
    // Asegurar 칤ndices v치lidos
    const safeIx = Math.min(23, Math.max(0, ix));
    const safeIy = Math.min(23, Math.max(0, iy));
    
    // Formato micro m치s robusto
    const micro = `${ALFABETO[safeIx]}${ALFABETO[safeIy]}${safeIx % 10}${safeIy % 10}${Math.floor((safeIx + safeIy) / 5)}`;
    
    const mRect = [
        getPointInGrid(coords, safeIx, safeIy, 24, 24),
        getPointInGrid(coords, safeIx+1, safeIy, 24, 24),
        getPointInGrid(coords, safeIx+1, safeIy+1, 24, 24),
        getPointInGrid(coords, safeIx, safeIy+1, 24, 24)
    ];

    // C치lculo de nano con mejor manejo de bordes
    const remX = (safePctX * 24) - safeIx;
    const remY = (safePctY * 24) - safeIy;
    
    const nix = Math.floor(remX * NANO_RES);
    const niy = Math.floor(remY * NANO_RES);
    
    // Asegurar 칤ndices nano v치lidos
    const safeNix = Math.min(NANO_RES-1, Math.max(0, nix));
    const safeNiy = Math.min(NANO_RES-1, Math.max(0, niy));
    
    const nano = `${ALFABETO[safeNix % 24]}${safeNiy % 10}`;

    const nRect = [
        getPointInGrid(coords, safeIx + safeNix/NANO_RES, safeIy + safeNiy/NANO_RES, 24, 24),
        getPointInGrid(coords, safeIx + (safeNix+1)/NANO_RES, safeIy + safeNiy/NANO_RES, 24, 24),
        getPointInGrid(coords, safeIx + (safeNix+1)/NANO_RES, safeIy + (safeNiy+1)/NANO_RES, 24, 24),
        getPointInGrid(coords, safeIx + safeNix/NANO_RES, safeIy + (safeNiy+1)/NANO_RES, 24, 24)
    ];

    return { micro, nano, mRect, nRect };
}

function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    if (!rawCuadricula) return;
    const z = mymap.getZoom();
    const bounds = mymap.getBounds();

    rawCuadricula.features.forEach(f => {
        const fBounds = L.geoJSON(f).getBounds();
        if (!bounds.intersects(fBounds)) return;
        
        if (z >= 10 && z < 14 && labelsEnabled) {
            L.marker(fBounds.getCenter(), {
                icon: L.divIcon({ className: 'watermark-label-fixed', html: f.properties.codigo, iconSize: [60, 20] })
            }).addTo(labelLayer);
        }

        if (z >= 14 && mymap.hasLayer(gridLayer)) {
            const coords = f.geometry.coordinates[0];
            for (let i = 0; i <= 24; i++) {
                let v = [], h = [];
                for(let j=0; j<=24; j++) {
                    v.push(getPointInGrid(coords, i, j, 24, 24));
                    h.push(getPointInGrid(coords, j, i, 24, 24));
                }
                L.polyline(v, {color: '#3498db', weight: 0.5, opacity: 0.3}).addTo(gridLayer);
                L.polyline(h, {color: '#3498db', weight: 0.5, opacity: 0.3}).addTo(gridLayer);
            }
        }
    });
}

// Carga de Datos
$.getJSON("cuadricula.geojson", d => { 
    rawCuadricula = d; 
    L.geoJSON(d, {style: {color: "#3498db", weight: 1, fillOpacity: 0.05}}).addTo(cuadriculaFisicaLayer);
    updateGridAndLabels(); 
});
$.getJSON("estafetas.geojson", d => { 
    rawZonas = d; 
    L.geoJSON(d, {style: {color: "#2c3e50", weight: 1.5, fillOpacity: 0.05}}).addTo(zonasGeoLayer); 
});
$.getJSON("estafetasl.geojson", d => L.geoJSON(d, {style: {color: "#e74c3c", weight: 2}}).addTo(rutasLayer));
$.getJSON("estafetasp.geojson", d => L.geoJSON(d, {pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5, color:"#27ae60", fillColor:"#2ecc71", fillOpacity:1})}).addTo(estafetasPointsLayer));

// EVENTO CLIC CORREGIDO
mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    if (!rawCuadricula || !rawZonas) return;
    
    const hZ = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawZonas));
    const hC = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawCuadricula));

    if (hC.length === 0) return;

    const useZonas = mymap.hasLayer(zonasGeoLayer) && hZ.length > 0;
    const macroID = useZonas ? hZ[0].feature.properties.VM_LEVEL : hC[0].feature.properties.codigo;
    
    let titulo = "ZONAS POSTALES", finalCode = macroID;
    const z = mymap.getZoom();

    if (z < 14) {
        L.geoJSON(useZonas ? hZ[0].feature : hC[0].feature, {
            style:{color:"#1a73e8", weight:4, fillOpacity:0.3}
        }).addTo(selectionLayer);
    } else if (z >= 14 && z < 17) {
        try {
            const data = getHierarchicalData(e.latlng.lat, e.latlng.lng, hC[0].feature);
            titulo = "츼REA POSTAL";
            finalCode += `-${data.micro}`;
            L.polygon(data.mRect, {color:"#1a73e8", weight:3, fillOpacity:0.4}).addTo(selectionLayer);
        } catch (err) {
            console.log("Error en micro:", err);
            // Fallback: mostrar solo el macro
            L.geoJSON(hC[0].feature, {
                style:{color:"#1a73e8", weight:4, fillOpacity:0.3}
            }).addTo(selectionLayer);
        }
    } else {
        try {
            const data = getHierarchicalData(e.latlng.lat, e.latlng.lng, hC[0].feature);
            titulo = "C칍DIGO POSTAL";
            finalCode += `-${data.micro}-${data.nano}`;
            L.polygon(data.nRect, {color:"#e67e22", weight:4, fillOpacity:0.5}).addTo(selectionLayer);
        } catch (err) {
            console.log("Error en nano:", err);
            // Fallback: mostrar micro
            try {
                const data = getHierarchicalData(e.latlng.lat, e.latlng.lng, hC[0].feature);
                titulo = "츼REA POSTAL";
                finalCode += `-${data.micro}`;
                L.polygon(data.mRect, {color:"#1a73e8", weight:3, fillOpacity:0.4}).addTo(selectionLayer);
            } catch (err2) {
                // Fallback final: mostrar solo el macro
                L.geoJSON(hC[0].feature, {
                    style:{color:"#1a73e8", weight:4, fillOpacity:0.3}
                }).addTo(selectionLayer);
            }
        }
    }

    const ws = encodeURIComponent(`游늸 Mi ubicaci칩n: ${finalCode}\nGPS: ${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`);
    L.popup({offset:[0,-5]}).setLatLng(e.latlng).setContent(`
        <div style="text-align:center;">
            <small>${titulo}</small><br>
            <b>${finalCode}</b><br>
            <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">游늸 MAPS</button>
            <button class="btn-ws" onclick="window.open('https://wa.me/?text=${ws}')">游눫 WS</button>
        </div>
    `).openOn(mymap);
});

// BUSCADOR
document.getElementById('search-btn').addEventListener('click', () => {
    const code = document.getElementById('search-input').value.trim().toUpperCase();
    if (!code || !rawCuadricula) return;
    let f = rawCuadricula.features.find(feat => feat.properties.codigo === code.split('-')[0]);
    if (f) {
        mymap.fitBounds(L.geoJSON(f).getBounds(), {padding: [50, 50]});
    }
});

// GPS
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const c = L.DomUtil.create('div', 'leaflet-bar');
        const b = L.DomUtil.create('a', 'locate-button', c);
        b.innerHTML = '游꿢';
        L.DomEvent.on(b, 'click', e => { 
            L.DomEvent.stopPropagation(e); 
            mymap.locate({setView:true, maxZoom:18}); 
        });
        return c;
    }
});
mymap.addControl(new LocateControl());

// CONTROL DE CAPAS
L.control.layers(null, {
    "Zonas": zonasGeoLayer,
    "Cuadr칤cula": cuadriculaFisicaLayer,
    "Rutas": rutasLayer,
    "Estafetas": estafetasPointsLayer,
    "C칩digo postal": gridLayer,
    "Selecci칩n": selectionLayer
}, {collapsed: false}).addTo(mymap);

$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGridAndLabels();
});

mymap.on('moveend zoomend', updateGridAndLabels);

// A침adir manejo de ubicaci칩n GPS
mymap.on('locationfound', function(e) {
    userLocationLayer.clearLayers();
    L.marker(e.latlng, {
        icon: L.divIcon({
            className: 'user-location-icon',
            html: '游늸',
            iconSize: [30, 30]
        })
    }).addTo(userLocationLayer);
    
    // Muestra popup con la ubicaci칩n
    L.popup()
        .setLatLng(e.latlng)
        .setContent(`<b>Tu ubicaci칩n</b><br>Lat: ${e.latlng.lat.toFixed(6)}<br>Lng: ${e.latlng.lng.toFixed(6)}`)
        .openOn(mymap);
});

mymap.on('locationerror', function(e) {
    alert("Error al obtener ubicaci칩n: " + e.message);
});
