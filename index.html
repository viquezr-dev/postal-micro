<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAMÁ - PRECISIÓN TOTAL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        input#search-input { border: none; padding: 8px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid #1a73e8; color: #1a73e8; }
        .watermark-label-fixed { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; }
        .label-micro { font-size: 10px!important; }
        .btn-nav, .btn-ws { display: inline-block; margin-top: 8px; padding: 8px 12px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; margin-right:5px;}
        .btn-nav { background-color: #3498db; }
        .btn-ws { background-color: #25D366; }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAMÁ</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: J4199">
    <button id="search-btn">IR</button>
</div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const cuadriculaLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
let labelsEnabled = true;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";

// Función para interpolar puntos en polígonos no rectangulares
function getPointInGrid(coords, col, row, totalCols, totalRows) {
    const pTopLeft = coords[0], pTopRight = coords[1], pBottomRight = coords[2], pBottomLeft = coords[3];
    
    // Interpolación bilineal para manejar la distorsión del GeoJSON
    const tX = col / totalCols;
    const tY = row / totalRows;

    const lat = (1-tY)*((1-tX)*pTopLeft[1] + tX*pTopRight[1]) + tY*((1-tX)*pBottomLeft[1] + tX*pBottomRight[1]);
    const lng = (1-tY)*((1-tX)*pTopLeft[0] + tX*pTopRight[0]) + tY*((1-tX)*pBottomLeft[0] + tX*pBottomRight[0]);
    
    return [lat, lng];
}

function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    const z = mymap.getZoom();
    if (!rawCuadricula || z < 14) return;

    const bounds = mymap.getBounds();

    rawCuadricula.features.forEach(f => {
        const coords = f.geometry.coordinates[0];
        const macroBounds = L.geoJSON(f).getBounds();
        if (!bounds.intersects(macroBounds)) return;

        // Dibujamos la rejilla micro (24x24) usando líneas exactas
        for (let i = 0; i <= 24; i++) {
            // Líneas Verticales interpoladas
            let vLine = [];
            for(let j=0; j<=24; j++) vLine.push(getPointInGrid(coords, i, j, 24, 24));
            L.polyline(vLine, {color: '#3498db', weight: 0.5, interactive: false}).addTo(gridLayer);

            // Líneas Horizontales interpoladas
            let hLine = [];
            for(let j=0; j<=24; j++) hLine.push(getPointInGrid(coords, j, i, 24, 24));
            L.polyline(hLine, {color: '#3498db', weight: 0.5, interactive: false}).addTo(gridLayer);
        }

        // Etiquetas Micro
        if (labelsEnabled && z >= 14 && z < 18) {
            for (let i = 0; i < 24; i++) {
                for (let j = 0; j < 24; j++) {
                    const center = getPointInGrid(coords, i + 0.5, j + 0.5, 24, 24);
                    if (bounds.contains(center)) {
                        const microC = `${ALFABETO[i]}${ALFABETO[j]}${i % 10}${j % 10}${Math.floor((i + j) / 5)}`;
                        L.marker(center, {
                            icon: L.divIcon({ 
                                className: 'watermark-label-fixed label-micro', 
                                html: `<div>${f.properties.codigo}</div><div>${microC}</div>`, 
                                iconSize: [40, 20] 
                            }),
                            interactive: false
                        }).addTo(labelLayer);
                    }
                }
            }
        }
    });
}

$.getJSON("cuadricula.geojson", d => { 
    rawCuadricula = d; 
    L.geoJSON(d, {style: {color: "#2c3e50", weight: 1, fillOpacity: 0.05}}).addTo(cuadriculaLayer);
    updateGridAndLabels(); 
});

mymap.on('moveend zoomend', updateGridAndLabels);
$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGridAndLabels();
});

// Click para obtener código
mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    const found = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], cuadriculaLayer);
    if (found.length > 0) {
        const feat = found[0].feature;
        const coords = feat.geometry.coordinates[0];
        
        // Calcular en qué celda cayó el click (usando proximidad)
        // Por simplicidad en este ejemplo, usamos una aproximación lineal:
        // (En un entorno real, aquí se usaría una matriz de transformación)
        
        const popupContent = `<b>Código: ${feat.properties.codigo}</b><br>
                              Lat: ${e.latlng.lat.toFixed(6)}<br>
                              Lon: ${e.latlng.lng.toFixed(6)}<br>
                              <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">MAPS</button>`;
        
        L.popup().setLatLng(e.latlng).setContent(popupContent).openOn(mymap);
    }
});
</script>
</body>
</html>
