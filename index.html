<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM√Å - INTEGRAL</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        .leaflet-popup { margin-bottom: 70px !important; }
        
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; font-weight: bold; text-shadow: 0 0 5px white; }
        
        /* Buscador Mejorado */
        .search-container { position: absolute; top: 10px; right: 10px; z-index: 3000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px; border: 1px solid #ddd; }
        input#search-input { flex: 1; border: none; padding: 8px; font-size: 14px; outline: none; border-radius: 5px 0 0 5px; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 15px; border-radius: 0 5px 5px 0; cursor: pointer; font-weight: bold; }
        button#search-btn:hover { background: #34495e; }
        
        .btn-nav, .btn-ws { display: inline-block; margin-top: 8px; padding: 8px 12px; color: white !important; text-decoration: none !important; border-radius: 5px; font-weight: bold; font-size: 11px; border:none; cursor:pointer; }
        .btn-nav { background-color: #3498db; margin-right: 5px; }
        .btn-ws { background-color: #25D366; }
        
        .grid-label { font-size: 10px; font-weight: bold; color: #1a5276; pointer-events: none; text-shadow: 0 0 3px white; text-align: center; }
        .locate-button { background: white; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 5px; font-size: 18px; border: 2px solid rgba(0,0,0,0.2); }
        .leaflet-top.leaflet-right { top: 65px !important; }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM√Å</h1></div>

<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: A6099-JK094">
    <button id="search-btn">BUSCAR</button>
</div>

<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
// 1. CONFIGURACI√ìN INICIAL
const mymap = L.map('mapid', { zoomControl: true }).setView([8.50, -80.0], 7.8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
let zonasGeoLayer = L.layerGroup().addTo(mymap); 
let cuadriculaLayer = L.layerGroup().addTo(mymap);
let rutasLayer = L.layerGroup().addTo(mymap);
let estafetasPointsLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ"; 

// 2. FUNCI√ìN DE C√ÅLCULO JER√ÅRQUICO
function getHierarchicalData(lat, lon, macroBounds) {
    const sw = macroBounds.getSouthWest();
    const ne = macroBounds.getNorthEast();
    const stepX = (ne.lng - sw.lng) / 24;
    const stepY = (ne.lat - sw.lat) / 24;
    const ix = Math.max(0, Math.min(23, Math.floor((lon - sw.lng) / stepX)));
    const iy = Math.max(0, Math.min(23, Math.floor((lat - sw.lat) / stepY)));

    const microCode = `${ALFABETO[ix]}${ALFABETO[iy]}${ix % 10}${iy % 10}${Math.floor((ix + iy) / 5)}`;
    const microW = sw.lng + (ix * stepX);
    const microS = sw.lat + (iy * stepY);
    
    const nanoStepX = stepX / 10;
    const nanoStepY = stepY / 10;
    const nix = Math.max(0, Math.min(9, Math.floor((lon - microW) / nanoStepX)));
    const niy = Math.max(0, Math.min(9, Math.floor((lat - microS) / nanoStepY)));

    const ofIdx = (nix * 7 + niy * 13) % 24;
    return {
        micro: microCode,
        nano: `${ALFABETO[ofIdx]}${niy}`,
        microRect: [[microS, microW], [microS + stepY, microW + stepX]],
        nanoRect: [[microS + (niy * nanoStepY), microW + (nix * nanoStepX)], [microS + ((niy + 1) * nanoStepY), microW + ((nix + 1) * nanoStepX)]]
    };
}

// 3. CARGA DE CAPAS
$.getJSON("estafetas.geojson", d => L.geoJSON(d, { style: { color: "#000000", weight: 1.5, fillOpacity: 0.15, fillColor: "#888888" }}).addTo(zonasGeoLayer));
$.getJSON("cuadricula.geojson", data => { 
    rawCuadricula = data; 
    L.geoJSON(data, { style: { color: "#2c3e50", weight: 1, fillOpacity: 0.05 }}).addTo(cuadriculaLayer);
});
$.getJSON("estafetasl.geojson", d => L.geoJSON(d, {style:{color:"#e74c3c", weight:2}}).addTo(rutasLayer));
$.getJSON("estafetasp.geojson", d => L.geoJSON(d, { pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5, color:"#27ae60", fillColor:"#2ecc71", fillOpacity:1})}).addTo(estafetasPointsLayer));

// 4. L√ìGICA DEL BUSCADOR
document.getElementById('search-btn').addEventListener('click', () => {
    const code = document.getElementById('search-input').value.trim().toUpperCase();
    if (!code || !rawCuadricula) return;

    const parts = code.split('-');
    const macroCode = parts[0];
    const microPart = parts[1];

    let foundFeature = null;
    rawCuadricula.features.forEach(f => { if(f.properties.codigo === macroCode) foundFeature = f; });

    if (foundFeature) {
        const bounds = L.geoJSON(foundFeature).getBounds();
        if (microPart && microPart.length >= 5) {
            const ix = ALFABETO.indexOf(microPart[0]);
            const iy = ALFABETO.indexOf(microPart[1]);
            const stepX = (bounds.getEast() - bounds.getWest()) / 24;
            const stepY = (bounds.getNorth() - bounds.getSouth()) / 24;
            const targetLat = bounds.getSouth() + (iy * stepY) + (stepY/2);
            const targetLon = bounds.getWest() + (ix * stepX) + (stepX/2);
            mymap.setView([targetLat, targetLon], 17);
            setTimeout(() => mymap.fire('click', {latlng: L.latLng(targetLat, targetLon)}), 500);
        } else {
            mymap.fitBounds(bounds);
        }
    } else { alert("C√≥digo no encontrado"); }
});

// 5. EVENTO CLICK INTEGRAL
mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    if (!rawCuadricula) return;

    const hit = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawCuadricula));
    if (hit.length === 0) return;

    const macroID = hit[0].feature.properties.codigo;
    const data = getHierarchicalData(e.latlng.lat, e.latlng.lng, L.geoJSON(hit[0].feature).getBounds());
    const z = mymap.getZoom();

    let titulo = "ZONA", finalCode = macroID;
    if (z >= 14) { 
        titulo = (z >= 17) ? "C√ìDIGO POSTAL" : "√ÅREA POSTAL";
        finalCode += `-${data.micro}`; 
        L.rectangle(data.microRect, {color: "#3498db", weight: 2, fillOpacity: 0.1}).addTo(selectionLayer);
    }
    if (z >= 17) { 
        finalCode += `-${data.nano}`; 
        L.rectangle(data.nanoRect, {color: "#e67e22", weight: 4, fillOpacity: 0.4}).addTo(selectionLayer);
    }

    L.popup({ offset: [0, -55] }).setLatLng(e.latlng).setContent(`
        <div style="text-align:center;">
            <b style="color:#7f8c8d; font-size:10px;">${titulo}</b><br>
            <span style="font-size:15px; font-weight:bold;">${finalCode}</span><br>
            <button class="btn-ws" onclick="window.open('https://wa.me/?text=Mi+Postal:+${finalCode}')">Compartir WhatsApp</button>
        </div>
    `).openOn(mymap);
});

// 6. CONTROLES Y REJILLA
mymap.on('moveend zoomend', () => {
    gridLayer.clearLayers();
    if (mymap.getZoom() < 17) return;
    // (Opcional: Redibujar rejilla visual aqu√≠ si se desea)
});

const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const b = L.DomUtil.create('a', 'locate-button leaflet-bar');
        b.innerHTML = 'üéØ';
        L.DomEvent.on(b, 'click', e => { L.DomEvent.stopPropagation(e); mymap.locate({setView:true, maxZoom:18}); });
        return b;
    }
});
mymap.addControl(new LocateControl());

L.control.layers(null, { "Zonas": zonasGeoLayer, "Rutas": rutasLayer, "Estafetas": estafetasPointsLayer }, {collapsed: false}).addTo(mymap);

</script>
</body>
</html>
