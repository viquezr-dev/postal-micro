<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM√Å</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        html, body, #mapid { width:100%; height:100%; margin:0; padding:0; }
        .map-title { position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:4000; }
        .map-title h1 { font-size:18px; margin:0; text-shadow:0 0 5px white; }

        .search-container {
            position:absolute; top:15px; right:10px; z-index:5000;
            display:flex; background:white; padding:5px;
            border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.2);
        }

        .watermark-label-fixed {
            background:none!important;
            border:none!important;
            color:#1a73e8;
            text-align:center;
            pointer-events:none;
            text-shadow:1px 1px 1px white;
        }
        .label-macro { font-size:14px; font-weight:600; }
        .label-micro { font-size:11px; }

        .toggle-watermark {
            position:absolute; bottom:30px; left:10px;
            z-index:5000; background:white; padding:8px;
            border-radius:5px; cursor:pointer;
            border:1px solid #1a73e8; color:#1a73e8;
        }
        .toggle-watermark.off { color:#777; border-color:#ccc; }

        .locate-button {
            background:white;
            width:34px; height:34px;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer;
            border-radius:5px;
            border:2px solid rgba(0,0,0,.2);
        }
    </style>
</head>

<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM√Å</h1></div>

<div class="search-container">
    <input id="search-input" placeholder="Ej: J4199" style="border:none;padding:6px">
    <button id="search-btn">IR</button>
</div>

<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
/* =======================
   MAPA BASE
======================= */
const mymap = L.map('mapid').setView([8.5, -80], 7.8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

mymap.createPane('watermarkPane');
mymap.getPane('watermarkPane').style.pointerEvents = 'none';

/* =======================
   CAPAS
======================= */
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const cuadriculaLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);

/* üî• capas separadas (FIX) */
const macroGridLayer = L.layerGroup().addTo(mymap);
const microGridLayer = L.layerGroup().addTo(mymap);
const nanoGridLayer  = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
let rawZonas = null;
let labelsEnabled = true;

const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";

/* =======================
   REJILLA CORREGIDA
======================= */
function updateGridAndLabels() {

    macroGridLayer.clearLayers();
    microGridLayer.clearLayers();
    nanoGridLayer.clearLayers();
    labelLayer.clearLayers();

    const z = mymap.getZoom();
    if (!rawCuadricula || z < 10) return;

    const bounds = mymap.getBounds();
    const round = v => Number(v.toFixed(10));

    rawCuadricula.features.forEach(f => {

        const mB = L.geoJSON(f).getBounds();
        if (!bounds.intersects(mB)) return;

        const macroCode = f.properties.codigo;

        if (z >= 10 && z < 14 && labelsEnabled) {
            L.marker(mB.getCenter(), {
                pane:'watermarkPane',
                icon:L.divIcon({
                    className:'watermark-label-fixed label-macro',
                    html:macroCode,
                    iconSize:[60,20]
                })
            }).addTo(labelLayer);
        }

        const sX = (mB.getEast() - mB.getWest()) / 24;
        const sY = (mB.getNorth() - mB.getSouth()) / 24;

        /* MICRO SOLO 14‚Äì17 */
        if (z >= 14 && z < 18) {
            for (let i=0;i<24;i++){
                for (let j=0;j<24;j++){
                    let s = round(mB.getSouth()+j*sY);
                    let w = round(mB.getWest()+i*sX);
                    let r = L.latLngBounds([s,w],[s+sY,w+sX]);
                    if (!bounds.intersects(r)) continue;

                    L.rectangle(r,{
                        color:"#1a73e8",
                        weight:0.4,
                        opacity:0.6,
                        fillOpacity:0,
                        interactive:false
                    }).addTo(microGridLayer);

                    if (labelsEnabled) {
                        const mc = `${ALFABETO[i]}${ALFABETO[j]}${i%10}${j%10}${Math.floor((i+j)/5)}`;
                        L.marker(r.getCenter(),{
                            pane:'watermarkPane',
                            icon:L.divIcon({
                                className:'watermark-label-fixed label-micro',
                                html:`${macroCode}<br>${mc}`,
                                iconSize:[60,28]
                            })
                        }).addTo(labelLayer);
                    }
                }
            }
        }

        /* NANO SOLO >=18 */
        if (z >= 18 && mB.contains(mymap.getCenter())) {
            const nsX = sX/10, nsY = sY/10;
            for (let i=0;i<24;i++){
                for (let j=0;j<24;j++){
                    let ms = mB.getSouth()+j*sY;
                    let mw = mB.getWest()+i*sX;
                    for (let ni=0;ni<10;ni++){
                        for (let nj=0;nj<10;nj++){
                            let s = round(ms+nj*nsY);
                            let w = round(mw+ni*nsX);
                            let r = L.latLngBounds([s,w],[s+nsY,w+nsX]);
                            if (!bounds.contains(r.getCenter())) continue;

                            L.rectangle(r,{
                                color:"#e67e22",
                                weight:0.3,
                                opacity:0.7,
                                fillOpacity:0,
                                interactive:false
                            }).addTo(nanoGridLayer);
                        }
                    }
                }
            }
        }
    });
}

/* =======================
   EVENTOS
======================= */
mymap.on('moveend zoomend', updateGridAndLabels);

$('#toggle-wm').click(()=>{
    labelsEnabled=!labelsEnabled;
    $('#toggle-wm').toggleClass('off').text(labelsEnabled?'TEXTO: ON':'TEXTO: OFF');
    updateGridAndLabels();
});

/* =======================
   CARGA DE DATOS
======================= */
$.getJSON("cuadricula.geojson",d=>{
    rawCuadricula=d;
    L.geoJSON(d,{style:{color:"#2c3e50",weight:1,fillOpacity:.05}}).addTo(cuadriculaLayer);
    updateGridAndLabels();
});

$.getJSON("estafetas.geojson",d=>{
    rawZonas=d;
    L.geoJSON(d,{style:{color:"#000",weight:1.5,fillOpacity:.1}}).addTo(zonasGeoLayer);
});

$.getJSON("estafetasl.geojson",d=>{
    L.geoJSON(d,{style:{color:"#e74c3c",weight:2}}).addTo(rutasLayer);
});

$.getJSON("estafetasp.geojson",d=>{
    L.geoJSON(d,{
        pointToLayer:(f,ll)=>L.circleMarker(ll,{
            radius:6,color:"#27ae60",fillColor:"#2ecc71",fillOpacity:1
        })
    }).addTo(estafetasPointsLayer);
});

/* =======================
   CONTROL DE CAPAS
======================= */
L.control.layers(null,{
    "Zonas":zonasGeoLayer,
    "Cuadr√≠cula":cuadriculaLayer,
    "Micro":microGridLayer,
    "Nano":nanoGridLayer,
    "Rutas":rutasLayer,
    "Estafetas":estafetasPointsLayer
},{collapsed:false}).addTo(mymap);
</script>

</body>
</html>
