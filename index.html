<!DOCTYPE html>
<html>
<head>
<title>SISTEMA POSTAL DE PANAMÁ</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

<style>
html,body,#mapid{width:100%;height:100%;margin:0}
.map-title{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:4000}
.map-title h1{font-size:18px;margin:0;text-shadow:0 0 5px white}
.watermark-label-fixed{
background:none!important;border:none!important;
pointer-events:none;text-align:center;
color:#1a73e8;text-shadow:1px 1px 1px white
}
.label-macro{font-size:14px;font-weight:600}
.label-micro{font-size:11px}
.toggle-watermark{
position:absolute;bottom:30px;left:10px;
background:white;padding:8px;border-radius:5px;
cursor:pointer;z-index:5000;border:1px solid #1a73e8
}
.toggle-watermark.off{color:#777;border-color:#ccc}
</style>
</head>

<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAMÁ</h1></div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
/* ================= MAPA ================= */
const mymap=L.map('mapid').setView([8.5,-80],7.8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

mymap.createPane('watermarkPane');
mymap.getPane('watermarkPane').style.pointerEvents='none';

/* ================= CAPAS ================= */
const cuadriculaLayer=L.layerGroup().addTo(mymap);
const zonasGeoLayer=L.layerGroup().addTo(mymap);
const rutasLayer=L.layerGroup().addTo(mymap);
const estafetasPointsLayer=L.layerGroup().addTo(mymap);
const selectionLayer=L.layerGroup().addTo(mymap);
const gridLayer=L.layerGroup().addTo(mymap);
const labelLayer=L.layerGroup().addTo(mymap);

/* ================= DATOS ================= */
let rawCuadricula=null;
let rawZonas=null;
let labelsEnabled=true;
const ALFABETO="ABCDEFGHJKLMNPQRSTUVWXYZ";

/* ================= GRID CORREGIDA ================= */
function updateGridAndLabels(){

gridLayer.clearLayers();
labelLayer.clearLayers();

const z=mymap.getZoom();
if(!rawCuadricula||z<10)return;

const bounds=mymap.getBounds();
const round=v=>Number(v.toFixed(10));

rawCuadricula.features.forEach(f=>{

const mB=L.geoJSON(f).getBounds();
if(!bounds.intersects(mB))return;

const macroCode=f.properties.codigo;

/* ===== LABEL MACRO ===== */
if(z>=10&&z<14&&labelsEnabled){
L.marker(mB.getCenter(),{
pane:'watermarkPane',
icon:L.divIcon({
className:'watermark-label-fixed label-macro',
html:macroCode,iconSize:[60,20]
}),interactive:false
}).addTo(labelLayer);
}

const south0=mB.getSouth();
const west0=mB.getWest();
const sX=(mB.getEast()-west0)/24;
const sY=(mB.getNorth()-south0)/24;

/* ===== MICRO (14–17) ===== */
if(z>=14&&z<18){
for(let j=0;j<24;j++){
for(let i=0;i<24;i++){

const south=south0+j*sY;
const north=south0+(j+1)*sY;
const west=west0+i*sX;
const east=west0+(i+1)*sX;

const rect=L.latLngBounds(
[round(south),round(west)],
[round(north),round(east)]
);
if(!bounds.intersects(rect))continue;

L.rectangle(rect,{
color:"#1a73e8",weight:0.4,opacity:0.6,
fillOpacity:0,interactive:false
}).addTo(gridLayer);

if(labelsEnabled){
const microC=`${ALFABETO[i]}${ALFABETO[j]}${i%10}${j%10}${Math.floor((i+j)/5)}`;
L.marker(rect.getCenter(),{
pane:'watermarkPane',
icon:L.divIcon({
className:'watermark-label-fixed label-micro',
html:`${macroCode}<br>${microC}`,
iconSize:[60,28]
}),interactive:false
}).addTo(labelLayer);
}
}}
}

/* ===== NANO (>=18) – SOLUCIÓN DEFINITIVA ===== */
if(z>=18&&mB.contains(mymap.getCenter())){

const nanoXSize=sX/10;
const nanoYSize=sY/10;

for(let microY=0;microY<24;microY++){
for(let microX=0;microX<24;microX++){

for(let subY=0;subY<10;subY++){
for(let subX=0;subX<10;subX++){

const nanoX=microX*10+subX;
const nanoY=microY*10+subY;

const south=south0+nanoY*nanoYSize;
const north=south0+(nanoY+1)*nanoYSize;
const west=west0+nanoX*nanoXSize;
const east=west0+(nanoX+1)*nanoXSize;

const rect=L.latLngBounds(
[round(south),round(west)],
[round(north),round(east)]
);

if(!bounds.contains(rect.getCenter()))continue;

L.rectangle(rect,{
color:"#e67e22",weight:0.3,opacity:0.7,
fillOpacity:0,interactive:false
}).addTo(gridLayer);

}}}}
}
});
}

/* ================= EVENTOS ================= */
mymap.on('moveend zoomend',updateGridAndLabels);

$('#toggle-wm').click(()=>{
labelsEnabled=!labelsEnabled;
$('#toggle-wm').toggleClass('off')
.text(labelsEnabled?'TEXTO: ON':'TEXTO: OFF');
updateGridAndLabels();
});

/* ================= CARGA ================= */
$.getJSON("cuadricula.geojson",d=>{
rawCuadricula=d;
L.geoJSON(d,{style:{color:"#2c3e50",weight:1,fillOpacity:.05}})
.addTo(cuadriculaLayer);
updateGridAndLabels();
});

$.getJSON("estafetas.geojson",d=>{
rawZonas=d;
L.geoJSON(d,{style:{color:"#000",weight:1.5,fillOpacity:.1}})
.addTo(zonasGeoLayer);
});

$.getJSON("estafetasl.geojson",d=>{
L.geoJSON(d,{style:{color:"#e74c3c",weight:2}})
.addTo(rutasLayer);
});

$.getJSON("estafetasp.geojson",d=>{
L.geoJSON(d,{
pointToLayer:(f,ll)=>L.circleMarker(ll,{
radius:6,color:"#27ae60",fillColor:"#2ecc71",fillOpacity:1
})
}).addTo(estafetasPointsLayer);
});

/* ================= CAPAS ================= */
L.control.layers(null,{
"Zonas":zonasGeoLayer,
"Cuadrícula":cuadriculaLayer,
"Rejilla":gridLayer,
"Rutas":rutasLayer,
"Estafetas":estafetasPointsLayer
},{collapsed:false}).addTo(mymap);

</script>
</body>
</html>
