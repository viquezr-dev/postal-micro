<!DOCTYPE html>
<html lang="es">
<head>
    <title>Sistema Postal Panam√° - C√≥digos de Georreferenciaci√≥n</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow: hidden;
        }
        
        #mapid { 
            width: 100%; 
            height: 100%; 
            background: #e8eef7;
        }
        
        /* Barra superior */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(90deg, #1a2a6c 0%, #204085 100%);
            color: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            font-size: 24px;
            color: #f1c40f;
        }
        
        .logo-text h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .logo-text p {
            margin: 0;
            font-size: 11px;
            opacity: 0.8;
            letter-spacing: 0.3px;
        }
        
        /* Panel de botones flotante */
        .floating-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e6ef;
            width: auto;
            min-width: 180px;
        }
        
        .panel-section {
            margin-bottom: 10px;
        }
        
        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .panel-title i {
            color: #1a73e8;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .panel-btn {
            background: white;
            color: #2c3e50;
            border: 1px solid #d1d9e6;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
        }
        
        .panel-btn:hover {
            background: #f0f7ff;
            border-color: #1a73e8;
            transform: translateY(-1px);
        }
        
        .panel-btn.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #d1d9e6;
            border-radius: 10px;
            transition: background 0.3s;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active {
            background: #27ae60;
        }
        
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        /* B√∫squeda emergente */
        .search-modal {
            display: none;
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 5001;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid #e0e6ef;
            width: 320px;
        }
        
        .search-modal.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .search-title {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            background: #f1f5f9;
        }
        
        .search-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        #search-input {
            flex: 1;
            border: 1px solid #d1d9e6;
            padding: 12px 15px;
            outline: none;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: 1px;
            border-radius: 8px;
            transition: all 0.3s;
            background: #f8fafc;
            color: #2c3e50;
            text-transform: uppercase;
        }
        
        #search-input:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            background: white;
        }
        
        #search-input::placeholder {
            color: #94a3b8;
            font-weight: normal;
            letter-spacing: normal;
        }
        
        #search-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 3px 8px rgba(39, 174, 96, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        #search-btn:hover {
            background: linear-gradient(135deg, #219653 0%, #27ae60 100%);
            transform: translateY(-1px);
            box-shadow: 0 5px 12px rgba(39, 174, 96, 0.4);
        }
        
        .search-hint {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
            text-align: center;
        }
        
        /* Bot√≥n de ubicaci√≥n */
        .locate-button {
            position: absolute;
            bottom: 130px;
            right: 20px;
            z-index: 1000;
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #1a73e8;
            transition: all 0.3s;
        }
        
        .locate-button:hover {
            background: #f0f7ff;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }
        
        /* Bot√≥n para mostrar/ocultar texto */
        .text-toggle-btn {
            position: absolute;
            bottom: 190px;
            right: 20px;
            z-index: 1000;
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #1a73e8;
            transition: all 0.3s;
        }
        
        .text-toggle-btn:hover {
            background: #f0f7ff;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }
        
        .text-toggle-btn.active {
            background: #1a73e8;
            color: white;
        }
        
        /* Ajustes para controles de Leaflet */
        .leaflet-top.leaflet-right {
            margin-top: 80px !important;
        }
        
        .leaflet-control-layers {
            border-radius: 8px !important;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Estilos para tooltips */
        .leaflet-tooltip.watermark-tooltip {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: rgba(0, 0, 0, 0.7);
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            pointer-events: none;
            font-family: 'Segoe UI', monospace;
        }
        
        .label-macro {
            color: #1a73e8 !important;
            font-size: 14px !important;
            font-weight: 800 !important;
        }
        
        .label-micro {
            color: #e67e22 !important;
            font-size: 11px !important;
            font-weight: 700 !important;
        }
        
        .label-hidden {
            display: none !important;
        }
        
        /* Popup mejorado */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            padding: 0 !important;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        }
        
        .leaflet-popup-content {
            margin: 0 !important;
            min-width: 280px;
        }
        
        .popup-header {
            font-weight: 700;
            display: block;
            margin-bottom: 0;
            padding: 16px 20px 12px;
            text-align: center;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
            background: linear-gradient(90deg, #1a2a6c 0%, #204085 100%);
        }
        
        .popup-body {
            padding: 20px;
            background: #f8fafc;
        }
        
        .codigo-final {
            background: linear-gradient(135deg, #1a2a6c 0%, #2a3a8c 100%);
            color: white;
            padding: 18px;
            border-radius: 10px;
            font-size: 22px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 16px;
            border: 2px solid #f1c40f;
            letter-spacing: 1.5px;
            box-shadow: 0 4px 8px rgba(26, 42, 108, 0.3);
            font-family: 'Courier New', monospace;
        }
        
        .btn-container {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-maps, .btn-ws {
            flex: 1;
            background: #4285F4;
            color: white !important;
            padding: 12px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 3px 6px rgba(66, 133, 244, 0.3);
        }
        
        .btn-maps:hover, .btn-ws:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(66, 133, 244, 0.4);
        }
        
        .btn-ws {
            background: linear-gradient(135deg, #25D366 0%, #1ebe5a 100%);
            box-shadow: 0 3px 6px rgba(37, 211, 102, 0.3);
        }
        
        .btn-ws:hover {
            box-shadow: 0 5px 10px rgba(37, 211, 102, 0.4);
        }
        
        /* Mensaje de error */
        .error-msg {
            color: #c0392b;
            font-weight: 600;
            text-align: center;
            padding: 20px;
            font-size: 13px;
            background: #fdf2f2;
            border-radius: 8px;
            border-left: 4px solid #c0392b;
        }
        
        /* Indicador de capas */
        .layer-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            color: #2c3e50;
            max-width: 250px;
            border-left: 4px solid #1a73e8;
        }
        
        .layer-title {
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .layer-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        /* Ajustes responsivos */
        @media (max-width: 768px) {
            .floating-panel {
                width: calc(100% - 40px);
                right: 10px;
                left: 10px;
                top: 70px;
            }
            
            .search-modal {
                width: calc(100% - 40px);
                right: 10px;
                left: 10px;
                top: 70px;
            }
            
            .top-bar {
                height: 50px;
                padding: 0 15px;
            }
            
            .logo-text h1 {
                font-size: 16px;
            }
            
            .layer-indicator {
                display: none;
            }
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .floating-panel, .search-modal, .locate-button, .text-toggle-btn {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>

<!-- Barra superior -->
<div class="top-bar">
    <div class="logo-container">
        <div class="logo-icon">
            <i class="fas fa-map-marked-alt"></i>
        </div>
        <div class="logo-text">
            <h1>SISTEMA POSTAL DE PANAM√Å</h1>
            <p>C√ìDIGOS DE GEORREFERENCIACI√ìN</p>
        </div>
    </div>
    <div style="font-size: 12px; opacity: 0.9;">
        <i class="fas fa-satellite"></i> Sistema de Cuadr√≠cula 6D
    </div>
</div>

<!-- Panel flotante de botones -->
<div class="floating-panel">
    <div class="panel-section">
        <div class="panel-title">
            <i class="fas fa-search"></i> B√öSQUEDA
        </div>
        <div class="btn-group">
            <button class="panel-btn" id="open-search-btn">
                <span>Buscar por c√≥digo</span>
                <i class="fas fa-external-link-alt"></i>
            </button>
        </div>
    </div>
    
    <div class="panel-section">
        <div class="panel-title">
            <i class="fas fa-layer-group"></i> CAPAS
        </div>
        <div class="btn-group">
            <button class="panel-btn" id="toggle-zonas-btn" data-layer="zonas">
                <span>Zonas (Referencia)</span>
                <div class="toggle-switch active" id="zonas-toggle"></div>
            </button>
            <button class="panel-btn" id="toggle-rutas-btn" data-layer="rutas">
                <span>Rutas</span>
                <div class="toggle-switch" id="rutas-toggle"></div>
            </button>
            <button class="panel-btn" id="toggle-estafetas-btn" data-layer="estafetas">
                <span>Estafetas</span>
                <div class="toggle-switch" id="estafetas-toggle"></div>
            </button>
        </div>
    </div>
</div>

<!-- Modal de b√∫squeda -->
<div class="search-modal" id="search-modal">
    <div class="search-header">
        <div class="search-title">
            <i class="fas fa-search"></i> BUSCAR POR C√ìDIGO
        </div>
        <button class="close-btn" id="close-search-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="search-input-group">
        <input type="text" id="search-input" placeholder="Ej: A1B2C3" maxlength="6" autocomplete="off">
        <button id="search-btn">
            <i class="fas fa-location-arrow"></i> IR
        </button>
    </div>
    <div class="search-hint">
        Ingresa un c√≥digo de 6 d√≠gitos para centrar el mapa en esa ubicaci√≥n
    </div>
</div>

<!-- Bot√≥n de ubicaci√≥n -->
<button class="locate-button" onclick="findMe()" title="Mi ubicaci√≥n">
    <i class="fas fa-crosshairs"></i>
</button>

<!-- Bot√≥n para mostrar/ocultar texto -->
<button class="text-toggle-btn" id="text-toggle-btn" title="Mostrar/ocultar etiquetas">
    <i class="fas fa-font"></i>
</button>

<!-- Mapa -->
<div id="mapid"></div>

<script>
// Configuraci√≥n inicial
const ORIGIN = { lat: 10.0, lng: -83.0 };
const PANAMA_LIMITS = { N: 10.0, S: 7.0, W: -83.0, E: -77.0 };
const PARAMS = {
    RES_MACRO: 0.143, 
    RES_MICRO: 0.143 / 24,
    RES_NANO: (0.143 / 24) / 25,
    ALFA: "23456789ABCDEFGHJKLMNPQRSTVWXYZ",
    MACRO_X_COUNT: Math.ceil((77.0 - 83.0) / -0.143)
};

// Variables de estado
let textVisible = true;
let zonasVisible = true;
let rutasVisible = false;
let estafetasVisible = false;

// Inicializar mapa con mejoras visuales
const mymap = L.map('mapid', { 
    zoomSnap: 0.1, 
    zoomControl: false,
    fadeAnimation: true,
    zoomAnimation: true,
    preferCanvas: true
}).setView([8.5, -80.0], 8);

// Capa de tiles con mejor contraste
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 19,
    opacity: 0.9
}).addTo(mymap);

// Control de zoom personalizado
L.control.zoom({ 
    position: 'bottomright',
    zoomInTitle: 'Acercar',
    zoomOutTitle: 'Alejar'
}).addTo(mymap);

// Capas
const layerZonas = L.geoJSON(null, {
    style: { 
        color: "#1a2a6c", 
        weight: 2, 
        fillOpacity: 0.05, 
        fillColor: "#3498db",
        dashArray: '5, 5'
    }
});

const layerMacro = L.layerGroup().addTo(mymap);
const layerMicro = L.layerGroup().addTo(mymap);
const layerNano = L.layerGroup().addTo(mymap);
const layerRutas = L.layerGroup();
const layerEstafetas = L.layerGroup();
const selectionLayer = L.layerGroup().addTo(mymap);

// Cargar datos GeoJSON
fetch('estafetas.geojson').then(r => r.json()).then(data => {
    layerZonas.addData(data);
    if (zonasVisible) {
        layerZonas.addTo(mymap);
    }
});

fetch('estafetasl.geojson').then(r => r.json()).then(data => {
    L.geoJSON(data, { 
        style: {
            color: '#d35400', 
            weight: 3,
            opacity: 0.7,
            dashArray: '8, 6'
        }, 
        onEachFeature: (f,l) => l.bindPopup(`<b>RUTA:</b> ${f.properties.RUTA}`) 
    }).addTo(layerRutas);
    if (rutasVisible) {
        layerRutas.addTo(mymap);
    }
});

fetch('estafetasp.geojson').then(r => r.json()).then(data => {
    L.geoJSON(data, { 
        pointToLayer: (f,ll) => L.circleMarker(ll, {
            radius: 8, 
            fillColor: '#27ae60', 
            color: '#fff', 
            weight: 2, 
            fillOpacity: 1
        }), 
        onEachFeature: (f,l) => l.bindPopup(`<b>ESTAFETA:</b> ${f.properties.ESTAF_NAME}`) 
    }).addTo(layerEstafetas);
    if (estafetasVisible) {
        layerEstafetas.addTo(mymap);
    }
});

// Funciones de codificaci√≥n/decodificaci√≥n
function encode(num, len) {
    let s = ""; 
    let n = Math.abs(Math.floor(num));
    for (let i = 0; i < len; i++) { 
        s = PARAMS.ALFA[n % 30] + s; 
        n = Math.floor(n / 30); 
    }
    return s;
}

function decode(s) {
    let n = 0;
    for (let i = 0; i < s.length; i++) {
        let idx = PARAMS.ALFA.indexOf(s[i].toUpperCase());
        n = n * 30 + idx;
    }
    return n;
}

function getGridInfo(lat, lng) {
    const mx = Math.floor((lng - ORIGIN.lng) / PARAMS.RES_MACRO);
    const my = Math.floor((ORIGIN.lat - lat) / PARAMS.RES_MACRO);
    const microX = Math.floor(((lng - ORIGIN.lng) % PARAMS.RES_MACRO) / PARAMS.RES_MICRO);
    const microY = Math.floor(((ORIGIN.lat - lat) % PARAMS.RES_MACRO) / PARAMS.RES_MICRO);
    const nanoX = Math.floor((((lng - ORIGIN.lng) % PARAMS.RES_MACRO) % PARAMS.RES_MICRO) / PARAMS.RES_NANO);
    const nanoY = Math.floor((((ORIGIN.lat - lat) % PARAMS.RES_MACRO) % PARAMS.RES_MICRO) / PARAMS.RES_NANO);
    return { 
        macro: encode((my * PARAMS.MACRO_X_COUNT) + mx, 2), 
        micro: encode((microY * 24) + microX, 2), 
        nano: encode((nanoY * 25) + nanoX, 2) 
    };
}

// Funci√≥n de selecci√≥n mejorada
function seleccionar(lat, lng) {
    selectionLayer.clearLayers();
    let zonaID = null;
    const testPoint = L.latLng(lat, lng);
    
    // Buscar zona
    layerZonas.eachLayer(layer => {
        if (layer.getBounds().contains(testPoint)) { 
            zonaID = layer.feature.properties.VM_LEVEL; 
        }
    });

    // Si no est√° en una zona definida
    if (!zonaID) {
        L.popup()
            .setLatLng([lat, lng])
            .setContent(`
                <div class="error-msg">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    <strong>√ÅREA NO DEFINIDA</strong><br>
                    Esta ubicaci√≥n se encuentra fuera de las zonas postales definidas.
                </div>
            `)
            .openOn(mymap);
        return;
    }

    const z = mymap.getZoom();
    const res = getGridInfo(lat, lng);
    
    // L√≥gica jer√°rquica seg√∫n zoom
    let gridPart = res.macro;
    if (z >= 13) gridPart += res.micro;
    if (z >= 16.5) gridPart += res.nano;
    
    const codigoFinal = `${zonaID}-${gridPart}`;
    const step = (z >= 16.5) ? PARAMS.RES_NANO : (z >= 13) ? PARAMS.RES_MICRO : PARAMS.RES_MACRO;
    
    // Calcular posici√≥n "snap"
    const snap = { 
        lng: Math.floor((lng - ORIGIN.lng) / step + 0.00000001) * step + ORIGIN.lng, 
        lat: ORIGIN.lat - Math.floor((ORIGIN.lat - lat) / step + 0.00000001) * step 
    };

    // Rect√°ngulo de selecci√≥n con mejor estilo
    L.rectangle([[snap.lat, snap.lng], [snap.lat - step, snap.lng + step]], { 
        color: '#f1c40f', 
        weight: 4, 
        fillOpacity: 0.15,
        fillColor: '#f1c40f',
        dashArray: '6, 4',
        className: 'selection-rectangle'
    }).addTo(selectionLayer);
    
    // Marcador mejorado
    L.marker([lat, lng], { 
        icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background: #e74c3c; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        }),
        zIndexOffset: 1000
    })
    .addTo(selectionLayer)
    .bindPopup(`
        <span class="popup-header">C√ìDIGO POSTAL</span>
        <div class="popup-body">
            <div class="codigo-final">${codigoFinal}</div>
            <div class="btn-container">
                <a href="https://maps.google.com/?q=${lat},${lng}" target="_blank" class="btn-maps">
                    <i class="fas fa-map-marker-alt"></i> VER EN MAPS
                </a>
                <a href="https://wa.me/?text=C√≥digo Postal Panam√°: ${codigoFinal} (Ubicaci√≥n: ${lat.toFixed(6)}, ${lng.toFixed(6)})" target="_blank" class="btn-ws">
                    <i class="fab fa-whatsapp"></i> COMPARTIR
                </a>
            </div>
        </div>
    `, { 
        offset: L.point(0, -15),
        closeButton: true,
        autoClose: false,
        closeOnClick: false
    }).openPopup();
}

// B√∫squeda por c√≥digo
document.getElementById('search-btn').addEventListener('click', () => {
    const val = document.getElementById('search-input').value.toUpperCase().replace(/\s/g, '');
    if (val.length !== 6) {
        // Mostrar mensaje de error temporal
        const input = document.getElementById('search-input');
        input.style.borderColor = '#e74c3c';
        input.style.boxShadow = '0 0 0 3px rgba(231, 76, 60, 0.2)';
        setTimeout(() => {
            input.style.borderColor = '#d1d9e6';
            input.style.boxShadow = 'none';
        }, 2000);
        return;
    }
    
    try {
        const idM = decode(val.substring(0,2)), 
              idMi = decode(val.substring(2,4)), 
              idN = decode(val.substring(4,6));
        
        const my = Math.floor(idM / PARAMS.MACRO_X_COUNT), 
              mx = idM % PARAMS.MACRO_X_COUNT;
        const miy = Math.floor(idMi / 24), 
              mix = idMi % 24;
        const nay = Math.floor(idN / 25), 
              nax = idN % 25;
        
        const lng = ORIGIN.lng + (mx * PARAMS.RES_MACRO) + (mix * PARAMS.RES_MICRO) + (nax * PARAMS.RES_NANO) + (PARAMS.RES_NANO / 2);
        const lat = ORIGIN.lat - (my * PARAMS.RES_MACRO) - (miy * PARAMS.RES_MICRO) - (nay * PARAMS.RES_NANO) - (PARAMS.RES_NANO / 2);
        
        // Cerrar modal de b√∫squeda
        document.getElementById('search-modal').classList.remove('active');
        
        // Animaci√≥n suave al punto
        mymap.flyTo([lat, lng], 18, {
            duration: 1.5,
            easeLinearity: 0.25
        });
        
        mymap.once('moveend', () => setTimeout(() => seleccionar(lat, lng), 500));
    } catch(e) { 
        // Mostrar error en el input
        const input = document.getElementById('search-input');
        input.style.borderColor = '#e74c3c';
        input.style.boxShadow = '0 0 0 3px rgba(231, 76, 60, 0.2)';
        setTimeout(() => {
            input.style.borderColor = '#d1d9e6';
            input.style.boxShadow = 'none';
        }, 2000);
    }
});

// Permitir b√∫squeda con Enter
document.getElementById('search-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('search-btn').click();
    }
});

// Renderizado de grids
function render() {
    layerMacro.clearLayers(); 
    layerMicro.clearLayers(); 
    layerNano.clearLayers();
    
    const z = mymap.getZoom();
    const b = mymap.getBounds();
    
    const draw = (step, layer, labelClass, color, weight, opacity) => {
        let sLng = Math.floor((b.getWest() - ORIGIN.lng) / step) * step + ORIGIN.lng;
        let sLat = ORIGIN.lat - Math.floor((ORIGIN.lat - b.getNorth()) / step) * step;
        let count = 0;
        
        for (let lo = sLng; lo < b.getEast() + step && lo < PANAMA_LIMITS.E; lo += step) {
            for (let la = sLat; la > b.getSouth() - step && la > PANAMA_LIMITS.S; la -= step) {
                if (count++ > 400) return;
                
                const data = getGridInfo(la - step/2, lo + step/2);
                
                // Dibujar rect√°ngulo
                L.rectangle([[la, lo], [la - step, lo + step]], { 
                    color: color, 
                    weight: weight, 
                    fill: false, 
                    opacity: opacity
                }).addTo(layer);
                
                // A√±adir etiqueta si corresponde
                if (labelClass && textVisible && ((labelClass==='label-macro' && z < 13) || (labelClass==='label-micro' && z >= 13 && z < 16.5))) {
                    const txt = labelClass === 'label-macro' ? data.macro : data.micro;
                    L.marker([la - step/2, lo + step/2], { 
                        icon: L.divIcon({className: 'inv'}) 
                    }).bindTooltip(txt, { 
                        permanent: true, 
                        direction: 'center', 
                        className: `watermark-tooltip ${labelClass}` 
                    }).addTo(layer);
                }
            }
        }
    };
    
    // Dibujar grids seg√∫n nivel de zoom
    if (z >= 9) draw(PARAMS.RES_MACRO, layerMacro, 'label-macro', '#1a73e8', 1.8, 0.4);
    if (z >= 13) draw(PARAMS.RES_MICRO, layerMicro, 'label-micro', '#e67e22', 1.2, 0.3);
    if (z >= 16.5) draw(PARAMS.RES_NANO, layerNano, '', '#2c3e50', 0.8, 0.2);
}

// Control de capas mejorado
const overlays = { 
    "üî≤ Cuadr√≠culas Macro": layerMacro, 
    "üó∫Ô∏è Zonas Postales": layerZonas, 
    "üõ£Ô∏è Rutas de Entrega": layerRutas, 
    "üìç Estafetas Postales": layerEstafetas 
};

L.control.layers(null, overlays, { 
    collapsed: true, 
    position: 'topright',
    autoZIndex: true
}).addTo(mymap);

// Funci√≥n de geolocalizaci√≥n
function findMe() { 
    if (navigator.geolocation) {
        mymap.locate({
            setView: true, 
            maxZoom: 16,
            enableHighAccuracy: true,
            timeout: 10000
        });
    } else {
        alert("Tu navegador no soporta geolocalizaci√≥n");
    }
}

// Eventos del mapa
mymap.on('locationfound', (e) => {
    seleccionar(e.latlng.lat, e.latlng.lng);
    
    // A√±adir c√≠rculo de precisi√≥n
    L.circle(e.latlng, {
        color: '#1a73e8',
        fillColor: '#1a73e8',
        fillOpacity: 0.1,
        radius: e.accuracy / 2
    }).addTo(selectionLayer);
});

mymap.on('click', (e) => seleccionar(e.latlng.lat, e.latlng.lng));
mymap.on('moveend', render);

// Render inicial
render();

// Control de botones
document.getElementById('open-search-btn').addEventListener('click', () => {
    document.getElementById('search-modal').classList.add('active');
    document.getElementById('search-input').focus();
});

document.getElementById('close-search-btn').addEventListener('click', () => {
    document.getElementById('search-modal').classList.remove('active');
});

// Bot√≥n para mostrar/ocultar texto
document.getElementById('text-toggle-btn').addEventListener('click', () => {
    textVisible = !textVisible;
    const btn = document.getElementById('text-toggle-btn');
    
    if (textVisible) {
        btn.classList.add('active');
        btn.title = "Ocultar etiquetas";
    } else {
        btn.classList.remove('active');
        btn.title = "Mostrar etiquetas";
    }
    
    // Actualizar mapa
    render();
});

// Control de capas con toggles
document.getElementById('toggle-zonas-btn').addEventListener('click', () => {
    zonasVisible = !zonasVisible;
    const toggle = document.getElementById('zonas-toggle');
    
    if (zonasVisible) {
        toggle.classList.add('active');
        layerZonas.addTo(mymap);
    } else {
        toggle.classList.remove('active');
        mymap.removeLayer(layerZonas);
    }
});

document.getElementById('toggle-rutas-btn').addEventListener('click', () => {
    rutasVisible = !rutasVisible;
    const toggle = document.getElementById('rutas-toggle');
    
    if (rutasVisible) {
        toggle.classList.add('active');
        layerRutas.addTo(mymap);
    } else {
        toggle.classList.remove('active');
        mymap.removeLayer(layerRutas);
    }
});

document.getElementById('toggle-estafetas-btn').addEventListener('click', () => {
    estafetasVisible = !estafetasVisible;
    const toggle = document.getElementById('estafetas-toggle');
    
    if (estafetasVisible) {
        toggle.classList.add('active');
        layerEstafetas.addTo(mymap);
    } else {
        toggle.classList.remove('active');
        mymap.removeLayer(layerEstafetas);
    }
});

// A√±adir efecto de carga
window.addEventListener('load', () => {
    document.body.style.opacity = '0';
    document.body.style.transition = 'opacity 0.5s';
    
    setTimeout(() => {
        document.body.style.opacity = '1';
    }, 100);
});
</script>
</body>
</html>
