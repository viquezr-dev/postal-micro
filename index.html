<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 250px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }

        .leaflet-top.leaflet-right { top: 75px !important; }

        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; border: 1px solid #1a73e8; font-weight: bold; }
        .watermark-label-fixed { background: none!important; border:none!important; color: #1a73e8!important; text-align: center; pointer-events: none!important; text-shadow: 1px 1px 1px white; font-weight: bold;}
        
        .btn-nav, .btn-ws { display: inline-block; margin-top: 8px; padding: 8px 12px; color: white!important; text-decoration: none!important; border-radius: 5px; font-weight: bold; font-size: 11px; border:none; cursor:pointer; }
        .btn-nav { background-color: #3498db; margin-right:5px; }
        .btn-ws { background-color: #25D366; }
        .locate-button { background: white; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 5px; border: 2px solid rgba(0,0,0,0.2); font-size: 18px; }
        
        .popup-info { text-align: center; min-width: 150px; }
        .popup-info small { color: #7f8c8d; text-transform: uppercase; font-size: 10px; letter-spacing: 1px; }
        .popup-info b { font-size: 16px; color: #2c3e50; display: block; margin: 2px 0; }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: J4199">
    <button id="search-btn">IR</button>
</div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

const clickDetectorLayer = L.geoJSON(null).addTo(mymap);

let rawCuadricula = null;
let rawZonas = null;
let labelsEnabled = true;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";

// Funci贸n de interpolaci贸n bilineal para precisi贸n milim茅trica en pol铆gonos distorsionados
function getPointInGrid(coords, col, row, totalCols, totalRows) {
    const p0 = coords[0], p1 = coords[1], p2 = coords[2], p3 = coords[3];
    const tX = col / totalCols;
    const tY = row / totalRows;
    const lat = (1-tY)*((1-tX)*p0[1] + tX*p1[1]) + tY*((1-tX)*p3[1] + tX*p2[1]);
    const lng = (1-tY)*((1-tX)*p0[0] + tX*p1[0]) + tY*((1-tX)*p3[0] + tX*p2[0]);
    return [lat, lng];
}

function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    const z = mymap.getZoom();
    if (!rawCuadricula || z < 10) return;

    const bounds = mymap.getBounds();

    rawCuadricula.features.forEach(f => {
        const polyBounds = L.geoJSON(f).getBounds();
        if (!bounds.intersects(polyBounds)) return;

        const coords = f.geometry.coordinates[0];
        
        // Nivel Macro
        if (z < 14 && labelsEnabled) {
            L.marker(polyBounds.getCenter(), {
                icon: L.divIcon({ className: 'watermark-label-fixed', html: f.properties.codigo, iconSize: [60, 20] }),
                interactive: false
            }).addTo(labelLayer);
        }

        // Nivel Micro (24x24)
        if (z >= 14) {
            for (let i = 0; i <= 24; i++) {
                let vLine = [], hLine = [];
                for(let j=0; j<=24; j++) {
                    vLine.push(getPointInGrid(coords, i, j, 24, 24));
                    hLine.push(getPointInGrid(coords, j, i, 24, 24));
                }
                L.polyline(vLine, {color: '#3498db', weight: 0.5, opacity: 0.5}).addTo(gridLayer);
                L.polyline(hLine, {color: '#3498db', weight: 0.5, opacity: 0.5}).addTo(gridLayer);
            }
            
            if (labelsEnabled && z < 18) {
                for (let i = 0; i < 24; i++) {
                    for (let j = 0; j < 24; j++) {
                        const center = getPointInGrid(coords, i + 0.5, j + 0.5, 24, 24);
                        if (bounds.contains(center)) {
                            const mCode = `${ALFABETO[i]}${ALFABETO[j]}${i % 10}${j % 10}${Math.floor((i + j) / 5)}`;
                            L.marker(center, {
                                icon: L.divIcon({ className: 'watermark-label-fixed', html: `<div style="font-size:9px; opacity:0.7">${f.properties.codigo}</div><div style="font-size:10px">${mCode}</div>`, iconSize: [40, 25] }),
                                interactive: false
                            }).addTo(labelLayer);
                        }
                    }
                }
            }
        }
    });
}

// Carga de Capas
$.getJSON("cuadricula.geojson", d => { 
    rawCuadricula = d; 
    clickDetectorLayer.addData(d);
    clickDetectorLayer.setStyle({ opacity: 0, fillOpacity: 0 });
    updateGridAndLabels(); 
});

$.getJSON("estafetas.geojson", d => {
    rawZonas = d;
    L.geoJSON(d, {style: {color: "#000", weight: 1.5, fillOpacity: 0.1}}).addTo(zonasGeoLayer);
});

$.getJSON("estafetasl.geojson", d => L.geoJSON(d, {style: {color: "#e74c3c", weight: 2}}).addTo(rutasLayer));
$.getJSON("estafetasp.geojson", d => L.geoJSON(d, {pointToLayer: (f, ll) => L.circleMarker(ll, {radius: 6, color: "#27ae60", fillColor: "#2ecc71", fillOpacity: 1})}).addTo(estafetasPointsLayer));

// EVENTO CLIC RESTAURADO CON TTULOS Y MARCADO PERMANENTE
mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    
    const results = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], clickDetectorLayer);
    
    if (results.length > 0) {
        const feature = results[0].feature;
        const coords = feature.geometry.coordinates[0];
        const b = L.geoJSON(feature).getBounds();
        const z = mymap.getZoom();

        // C谩lculo de c贸digos jer谩rquicos
        const ix = Math.max(0, Math.min(23, Math.floor(((e.latlng.lng - b.getWest()) / (b.getEast() - b.getWest())) * 24)));
        const iy = Math.max(0, Math.min(23, Math.floor(((e.latlng.lat - b.getSouth()) / (b.getNorth() - b.getSouth())) * 24)));
        const micro = `${ALFABETO[ix]}${ALFABETO[iy]}${ix % 10}${iy % 10}${Math.floor((ix + iy) / 5)}`;

        let finalCode = feature.properties.codigo;
        let titulo = "ZONA POSTAL";
        
        if (z >= 14 && z < 17) {
            titulo = "REA POSTAL";
            finalCode += `-${micro}`;
            const polyPoints = [
                getPointInGrid(coords, ix, iy, 24, 24),
                getPointInGrid(coords, ix+1, iy, 24, 24),
                getPointInGrid(coords, ix+1, iy+1, 24, 24),
                getPointInGrid(coords, ix, iy+1, 24, 24)
            ];
            L.polygon(polyPoints, {color: '#1a73e8', weight: 4, fillOpacity: 0.4}).addTo(selectionLayer);
        } else if (z >= 17) {
            titulo = "CDIGO POSTAL";
            const nix = Math.max(0, Math.min(9, Math.floor((((e.latlng.lng - b.getWest()) / (b.getEast() - b.getWest())) * 24 - ix) * 10)));
            const niy = Math.max(0, Math.min(9, Math.floor((((e.latlng.lat - b.getSouth()) / (b.getNorth() - b.getSouth())) * 24 - iy) * 10)));
            const nano = `${ALFABETO[(nix * 7 + niy * 13) % 24]}${niy}`;
            finalCode += `-${micro}-${nano}`;
            
            const nanoPoints = [
                getPointInGrid(coords, ix + nix/10, iy + niy/10, 24, 24),
                getPointInGrid(coords, ix + (nix+1)/10, iy + niy/10, 24, 24),
                getPointInGrid(coords, ix + (nix+1)/10, iy + (niy+1)/10, 24, 24),
                getPointInGrid(coords, ix + nix/10, iy + (niy+1)/10, 24, 24)
            ];
            L.polygon(nanoPoints, {color: '#e67e22', weight: 5, fillOpacity: 0.5}).addTo(selectionLayer);
        } else {
            L.geoJSON(feature, {style: {color: '#1a73e8', weight: 4, fillOpacity: 0.3}}).addTo(selectionLayer);
        }

        const wsUrl = `https://wa.me/?text=${encodeURIComponent(" Mi Ubicaci贸n Postal: " + finalCode + "\nGPS: " + e.latlng.lat.toFixed(6) + "," + e.latlng.lng.toFixed(6))}`;
        
        L.popup().setLatLng(e.latlng).setContent(`
            <div class="popup-info">
                <small>${titulo}</small>
                <b>${finalCode}</b>
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')"> MAPS</button>
                <button class="btn-ws" onclick="window.open('${wsUrl}')"> WS</button>
            </div>
        `).openOn(mymap);
    }
});

// Buscador
$('#search-btn').click(() => {
    const val = $('#search-input').val().toUpperCase();
    if (!rawCuadricula) return;
    const feat = rawCuadricula.features.find(f => f.properties.codigo === val);
    if (feat) {
        mymap.fitBounds(L.geoJSON(feat).getBounds());
        selectionLayer.clearLayers();
        L.geoJSON(feat, {style: {color: '#1a73e8', weight: 4, fillOpacity: 0.2}}).addTo(selectionLayer);
    }
});

// Mi Ubicaci贸n
const LocateBtn = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const div = L.DomUtil.create('div', 'locate-button leaflet-bar');
        div.innerHTML = '';
        div.onclick = () => mymap.locate({setView: true, maxZoom: 16});
        return div;
    }
});
mymap.addControl(new LocateBtn());

mymap.on('locationfound', e => {
    userLocationLayer.clearLayers();
    L.circleMarker(e.latlng, {radius: 7, color: 'white', weight:2, fillColor: '#3498db', fillOpacity: 1}).addTo(userLocationLayer);
});

// Control Capas
L.control.layers(null, {
    "Zonas": zonasGeoLayer,
    "Cuadr铆cula": clickDetectorLayer,
    "Rutas": rutasLayer,
    "Estafetas": estafetasPointsLayer,
    "Rejilla Micro": gridLayer
}, {collapsed: false}).addTo(mymap);

$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGridAndLabels();
});

mymap.on('moveend zoomend', updateGridAndLabels);
</script>
</body>
</html>
