<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAMÁ</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .leaflet-popup { margin-bottom: 70px !important; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; font-weight: bold; text-shadow: 0 0 5px white; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px; }
        input#search-input { flex: 1; border: none; padding: 8px; font-size: 14px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .leaflet-top.leaflet-right { top: 100px !important; }
        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; font-weight: bold; font-size: 11px; border: 1px solid #1a73e8; color: #1a73e8; }
        .toggle-watermark.off { color: #666; border-color: #ccc; }
        .watermark-label-fixed { background: none !important; border: none !important; color: #1a73e8 !important; text-align: center; pointer-events: none !important; text-shadow: 1px 1px 1px white; }
        .label-micro { font-size: 10px !important; }
        .label-macro { font-size: 14px !important; font-weight: 600 !important; }
        .btn-nav, .btn-ws { display: inline-block; margin-top: 8px; padding: 8px 12px; color: white !important; text-decoration: none !important; border-radius: 5px; font-weight: bold; font-size: 11px; border:none; cursor:pointer; }
        .btn-nav { background-color: #3498db; margin-right: 5px; }
        .btn-ws { background-color: #25D366; }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAMÁ</h1></div>
<div class="search-container"><input type="text" id="search-input" placeholder="Ej: J4199"><button id="search-btn">IR</button></div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid').setView([8.50, -80.0], 7.8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

mymap.createPane('watermarkPane');
mymap.getPane('watermarkPane').style.zIndex = 650;
mymap.getPane('watermarkPane').style.pointerEvents = 'none';

let labelsEnabled = true;
const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap); 
const selectionLayer = L.layerGroup().addTo(mymap);
const zonasGeoLayer = L.layerGroup().addTo(mymap); 
const cuadriculaLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
let rawZonas = null;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ"; 

function getMacroBounds(feature) {
    const coords = feature.geometry.coordinates[0];
    const lats = coords.map(c => c[1]), lngs = coords.map(c => c[0]);
    return { minLat: Math.min(...lats), maxLat: Math.max(...lats), minLng: Math.min(...lngs), maxLng: Math.max(...lngs) };
}

function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    const z = mymap.getZoom();
    if (!rawCuadricula || z < 10) return;

    const bounds = mymap.getBounds();
    rawCuadricula.features.forEach(f => {
        const b = getMacroBounds(f);
        const macroRect = L.latLngBounds([b.minLat, b.minLng], [b.maxLat, b.maxLng]);
        if (!bounds.intersects(macroRect)) return;

        // 1. DIBUJAR LÍNEAS DE REJILLA (Elimina traslapes)
        if (z >= 14 && mymap.hasLayer(gridLayer)) {
            const sX = (b.maxLng - b.minLng) / 24;
            const sY = (b.maxLat - b.minLat) / 24;

            const style = { color: "#1a73e8", weight: 0.6, opacity: 0.6, interactive: false };

            // Líneas Verticales
            for (let i = 0; i <= 24; i++) {
                const lng = b.minLng + (i * sX);
                L.polyline([[b.minLat, lng], [b.maxLat, lng]], style).addTo(gridLayer);
            }
            // Líneas Horizontales
            for (let j = 0; j <= 24; j++) {
                const lat = b.minLat + (j * sY);
                L.polyline([[lat, b.minLng], [lat, b.maxLng]], style).addTo(gridLayer);
            }

            // 2. ETIQUETAS (Solo si Cuadrícula está activa)
            if (labelsEnabled && z >= 14 && z < 18 && mymap.hasLayer(cuadriculaLayer)) {
                for (let i = 0; i < 24; i++) {
                    for (let j = 0; j < 24; j++) {
                        const center = [b.minLat + (j * sY) + sY/2, b.minLng + (i * sX) + sX/2];
                        if (bounds.contains(center)) {
                            const microC = `${ALFABETO[i]}${ALFABETO[j]}${i % 10}${j % 10}${Math.floor((i + j) / 5)}`;
                            L.marker(center, {
                                pane: 'watermarkPane',
                                icon: L.divIcon({ className: 'watermark-label-fixed label-micro', html: `<div>${f.properties.codigo}</div><div>${microC}</div>`, iconSize: [60, 30] })
                            }).addTo(labelLayer);
                        }
                    }
                }
            }
        }
    });
}

// Lógica de botones y eventos (Sin cambios)
$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).toggleClass('off').text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGridAndLabels();
});

mymap.on('overlayadd overlayremove moveend zoomend', updateGridAndLabels);

$.getJSON("estafetas.geojson", d => { rawZonas = d; L.geoJSON(d, {style:{color:"#000", weight:1.5, fillOpacity:0.1, fillColor:"#888"}}).addTo(zonasGeoLayer); });
$.getJSON("cuadricula.geojson", d => { rawCuadricula = d; L.geoJSON(d, {style:{color:"#2c3e50", weight:1, fillOpacity:0.05}}).addTo(cuadriculaLayer); updateGridAndLabels(); });

L.control.layers(null, {
    "Zonas": zonasGeoLayer,
    "Cuadrícula": cuadriculaLayer,
    "Rejilla Dinámica": gridLayer
}, {collapsed: false}).addTo(mymap);
</script>
</body>
</html>
