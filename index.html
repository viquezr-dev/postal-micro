<!DOCTYPE html>
<html>
<head>
<title>SISTEMA POSTAL DE PANAMÁ</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

<style>
html, body, #mapid { height:100%; margin:0; }
.watermark-label-fixed {
    background:none!important;
    border:none!important;
    color:#1a73e8;
    font-size:11px;
    text-align:center;
    pointer-events:none;
    text-shadow:1px 1px 2px white;
}
</style>
</head>

<body>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
/* =========================
   MAPA BASE
========================= */
const map = L.map('mapid').setView([8.5, -80], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

map.createPane('labels');
map.getPane('labels').style.pointerEvents = 'none';

/* =========================
   CAPAS
========================= */
const gridLayer = L.layerGroup().addTo(map);
const labelLayer = L.layerGroup().addTo(map);
const selectionLayer = L.layerGroup().addTo(map);
const cuadriculaLayer = L.layerGroup().addTo(map);

let rawCuadricula = null;

/* =========================
   CONSTANTES GLOBALES (CLAVE)
========================= */
const GLOBAL_LAT_ORIGIN = -90;
const GLOBAL_LNG_ORIGIN = -180;

/* Macro fijo 10x10 km (en grados aprox) */
const MACRO_LAT = 0.090;
const MACRO_LNG = 0.090;

/* Micro y Nano */
const MICRO_DIV = 24;
const NANO_DIV = 10;

const NANO_LAT = MACRO_LAT / (MICRO_DIV * NANO_DIV);
const NANO_LNG = MACRO_LNG / (MICRO_DIV * NANO_DIV);

/* =========================
   DIBUJO DE REJILLAS
========================= */
function updateGrid() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();

    if (!rawCuadricula) return;
    const z = map.getZoom();
    if (z < 17) return;

    const bounds = map.getBounds();

    rawCuadricula.features.forEach(f => {
        const macroBounds = L.geoJSON(f).getBounds();
        if (!bounds.intersects(macroBounds)) return;

        /* === NANO GLOBAL (ALINEADO) === */
        const startX = Math.floor((bounds.getWest() - GLOBAL_LNG_ORIGIN) / NANO_LNG);
        const endX   = Math.floor((bounds.getEast() - GLOBAL_LNG_ORIGIN) / NANO_LNG);
        const startY = Math.floor((bounds.getSouth() - GLOBAL_LAT_ORIGIN) / NANO_LAT);
        const endY   = Math.floor((bounds.getNorth() - GLOBAL_LAT_ORIGIN) / NANO_LAT);

        for (let x = startX; x <= endX; x++) {
            for (let y = startY; y <= endY; y++) {

                const west  = GLOBAL_LNG_ORIGIN + x * NANO_LNG;
                const east  = west + NANO_LNG;
                const south = GLOBAL_LAT_ORIGIN + y * NANO_LAT;
                const north = south + NANO_LAT;

                const nanoBounds = L.latLngBounds([south, west],[north, east]);

                /* solo dibuja si intersecta el macro */
                if (!macroBounds.intersects(nanoBounds)) continue;

                L.rectangle(nanoBounds,{
                    color:"#e67e22",
                    weight:0.3,
                    opacity:0.7,
                    fillOpacity:0.05,
                    interactive:false
                }).addTo(gridLayer);
            }
        }
    });
}

/* =========================
   CLICK (NO SE TOCÓ)
========================= */
map.on("click", e => {
    selectionLayer.clearLayers();
    if (!rawCuadricula) return;

    const hit = leafletPip.pointInLayer(
        [e.latlng.lng, e.latlng.lat],
        L.geoJSON(rawCuadricula)
    );

    if (!hit.length) {
        L.popup().setLatLng(e.latlng)
        .setContent("Área no válida").openOn(map);
        return;
    }

    const f = hit[0].feature;
    const macroBounds = L.geoJSON(f).getBounds();

    /* Nano global */
    const nx = Math.floor((e.latlng.lng - GLOBAL_LNG_ORIGIN) / NANO_LNG);
    const ny = Math.floor((e.latlng.lat - GLOBAL_LAT_ORIGIN) / NANO_LAT);

    const west  = GLOBAL_LNG_ORIGIN + nx * NANO_LNG;
    const south = GLOBAL_LAT_ORIGIN + ny * NANO_LAT;

    const nanoRect = L.latLngBounds(
        [south, west],
        [south + NANO_LAT, west + NANO_LNG]
    );

    L.rectangle(nanoRect,{
        color:"#e67e22",
        weight:4,
        fillOpacity:0.3
    }).addTo(selectionLayer);

    const code = `${f.properties.codigo}-N${nx}${ny}`;

    L.popup()
      .setLatLng(e.latlng)
      .setContent(`<b>CÓDIGO POSTAL</b><br>${code}`)
      .openOn(map);
});

/* =========================
   CARGA GEOJSON
========================= */
$.getJSON("cuadricula.geojson", d => {
    rawCuadricula = d;
    L.geoJSON(d,{
        style:{color:"#2c3e50",weight:1,fillOpacity:0.05}
    }).addTo(cuadriculaLayer);
    updateGrid();
});

map.on("moveend zoomend", updateGrid);

/* =========================
   CONTROL CAPAS
========================= */
L.control.layers(null,{
    "Cuadrícula": cuadriculaLayer,
    "Rejilla Nano": gridLayer
},{collapsed:false}).addTo(map);

</script>
</body>
</html>
