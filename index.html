<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM√Å</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Roboto', 'Arial', sans-serif; }
        .leaflet-popup { margin-bottom: 70px !important; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 16px; color: #5f6368; font-weight: 400; text-shadow: 0 0 3px white; letter-spacing: 1px; }
        
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 4px; border-radius: 24px; box-shadow: 0 1px 6px rgba(32,33,36,0.28); width: 260px; border: 1px solid #dfe1e5; }
        input#search-input { flex: 1; border: none; padding: 8px 15px; font-size: 14px; outline: none; border-radius: 24px; }
        button#search-btn { background: none; color: #1a73e8; border: none; padding: 8px 12px; cursor: pointer; font-weight: 500; }
        
        .leaflet-top.leaflet-right { top: 80px !important; }

        /* ESTILO TIPO PLUS CODES (MINIMALISTA) */
        .watermark-label-fixed {
            background: none !important; border: none !important; box-shadow: none !important;
            color: #70757a !important; /* Gris Google Maps */
            font-weight: 400 !important;
            text-align: center; pointer-events: none !important; 
            white-space: nowrap;
        }
        .label-macro { font-size: 14px !important; letter-spacing: 1px; }
        .label-micro { font-size: 10px !important; color: #8a8a8a !important; }

        .btn-nav, .btn-ws { display: inline-block; margin-top: 8px; padding: 8px 12px; color: white !important; text-decoration: none !important; border-radius: 4px; font-weight: 500; font-size: 11px; border:none; cursor:pointer; }
        .btn-nav { background-color: #1a73e8; margin-right: 5px; }
        .btn-ws { background-color: #34a853; }
        .locate-button { background: white; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 4px; font-size: 18px; border: 2px solid rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM√Å</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Buscar c√≥digo...">
    <button id="search-btn">BUSCAR</button>
</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid', { zoomControl: true }).setView([8.50, -80.0], 7.8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

mymap.createPane('watermarkPane');
mymap.getPane('watermarkPane').style.zIndex = 650;
mymap.getPane('watermarkPane').style.pointerEvents = 'none';

const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap); 
const selectionLayer = L.layerGroup().addTo(mymap);
const zonasGeoLayer = L.layerGroup().addTo(mymap); 
const cuadriculaLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
let rawZonas = null;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ"; 

function getHierarchicalData(lat, lon, macroFeat) {
    const b = L.geoJSON(macroFeat).getBounds();
    const sw = b.getSouthWest(), ne = b.getNorthEast();
    const sX = (ne.lng - sw.lng) / 24, sY = (ne.lat - sw.lat) / 24;
    const ix = Math.max(0, Math.min(23, Math.floor((lon - sw.lng) / sX)));
    const iy = Math.max(0, Math.min(23, Math.floor((lat - sw.lat) / sY)));
    
    const micro = `${ALFABETO[ix]}${ALFABETO[iy]}${ix % 10}${iy % 10}${Math.floor((ix + iy) / 5)}`;
    const mRect = [[sw.lat + (iy * sY), sw.lng + (ix * sX)], [sw.lat + ((iy + 1) * sY), sw.lng + ((ix + 1) * sX)]];
    
    const nsX = sX / 10, nsY = sY / 10;
    const nix = Math.max(0, Math.min(9, Math.floor((lon - (sw.lng + ix * sX)) / nsX)));
    const niy = Math.max(0, Math.min(9, Math.floor((lat - (sw.lat + iy * sY)) / nsY)));
    const nano = `${ALFABETO[(nix * 7 + niy * 13) % 24]}${niy}`;
    const nRect = [[sw.lat + iy * sY + niy * nsY, sw.lng + ix * sX + nix * nsX], [sw.lat + iy * sY + (niy + 1) * nsY, sw.lng + ix * sX + (nix + 1) * nsX]];
    
    return { micro, nano, mRect, nRect };
}

function updateGridAndLabels() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    const z = mymap.getZoom();
    if (!rawCuadricula || !mymap.hasLayer(gridLayer)) return;

    const bounds = mymap.getBounds();
    rawCuadricula.features.forEach(f => {
        const mB = L.geoJSON(f).getBounds();
        if (!bounds.intersects(mB)) return;

        const macroCode = f.properties.codigo;

        // NIVEL MACRO (Zoom < 14) - Limpio y centrado
        if (z < 14) {
            L.marker(mB.getCenter(), {
                pane: 'watermarkPane',
                icon: L.divIcon({ className: 'watermark-label-fixed label-macro', html: macroCode, iconSize: [60, 20] }),
                interactive: false
            }).addTo(labelLayer);
        }

        // NIVEL MICRO (Zoom 14-17) - Cuadr√≠cula azul muy clara
        if (z >= 14 && z < 18) {
            const sX = (mB.getEast() - mB.getWest()) / 24, sY = (mB.getNorth() - mB.getSouth()) / 24;
            for (let i = 0; i < 24; i++) {
                for (let j = 0; j < 24; j++) {
                    let s = mB.getSouth() + (j * sY), w = mB.getWest() + (i * sX);
                    let rectB = L.latLngBounds([s, w], [s + sY, w + sX]);
                    if (bounds.intersects(rectB)) {
                        L.rectangle(rectB, { color: "#dadce0", weight: 0.5, fillOpacity: 0, interactive: false }).addTo(gridLayer);
                        
                        // Solo poner etiqueta Micro si el zoom no es demasiado alto para no solapar con Nano
                        if (z < 17) {
                            const microC = `${ALFABETO[i]}${ALFABETO[j]}${i % 10}${j % 10}${Math.floor((i + j) / 5)}`;
                            L.marker(rectB.getCenter(), {
                                pane: 'watermarkPane',
                                icon: L.divIcon({ className: 'watermark-label-fixed label-micro', html: microC, iconSize: [50, 20] }),
                                interactive: false
                            }).addTo(labelLayer);
                        }
                    }
                }
            }
        }

        // NIVEL NANO (Zoom 18+) - SIN MARCAS DE AGUA (Solo cuadr√≠cula)
        if (z >= 18) {
            const sX = (mB.getEast() - mB.getWest()) / 24, sY = (mB.getNorth() - mB.getSouth()) / 24;
            const nsX = sX / 10, nsY = sY / 10;
            if (mB.contains(mymap.getCenter())) {
                for (let i = 0; i < 24; i++) {
                    for (let j = 0; j < 24; j++) {
                        let mS = mB.getSouth() + (j * sY), mW = mB.getWest() + (i * sX);
                        if (bounds.intersects([[mS, mW], [mS + sY, mW + sX]])) {
                            for (let ni = 0; ni < 10; ni++) {
                                for (let nj = 0; nj < 10; nj++) {
                                    let ns = mS + (nj * nsY), nw = mW + (ni * nsX);
                                    let nRectB = L.latLngBounds([ns, nw], [ns + nsY, nw + nsX]);
                                    if (bounds.contains(nRectB.getCenter())) {
                                        L.rectangle(nRectB, { color: "#e8eaed", weight: 0.3, fillOpacity: 0.1, interactive: false }).addTo(gridLayer);
                                        // AQU√ç SE ELIMIN√ì EL L.marker PARA QUE NO HAYA MARCA DE AGUA NANO
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    });
}

mymap.on('moveend zoomend', updateGridAndLabels);

// Carga de archivos
$.getJSON("estafetas.geojson", d => { rawZonas = d; L.geoJSON(d, {style:{color:"#bdc1c6", weight:1, fillOpacity:0.05}}).addTo(zonasGeoLayer); });
$.getJSON("cuadricula.geojson", d => { rawCuadricula = d; L.geoJSON(d, {style:{color:"#dadce0", weight:1, fillOpacity:0.02}}).addTo(cuadriculaLayer); updateGridAndLabels(); });
$.getJSON("estafetasl.geojson", d => L.geoJSON(d, {style:{color:"#f28b82", weight:1.5}}).addTo(rutasLayer));
$.getJSON("estafetasp.geojson", d => L.geoJSON(d, {pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:4, color:"#81c995", fillColor:"#81c995", fillOpacity:1})}).addTo(estafetasPointsLayer));

// Click
mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    if (!rawCuadricula) return;
    const hC = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawCuadricula));
    if (hC.length === 0) return;

    const data = getHierarchicalData(e.latlng.lat, e.latlng.lng, hC[0].feature);
    const z = mymap.getZoom();
    let finalCode = hC[0].feature.properties.codigo;

    if (z >= 14) finalCode += `-${data.micro}`;
    if (z >= 17) finalCode += `-${data.nano}`;

    L.rectangle(z >= 17 ? data.nRect : data.mRect, {color:"#1a73e8", weight:2, fillOpacity:0.15}).addTo(selectionLayer);

    const ws = encodeURIComponent(`üìç Mi ubicaci√≥n: ${finalCode}\nGPS: ${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`);
    L.popup({offset:[0,-45]}).setLatLng(e.latlng).setContent(`
        <div style="text-align:center; min-width:150px;">
            <span style="font-size:15px; color:#3c4043; font-weight:500;">${finalCode}</span><br>
            <button class="btn-nav" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${e.latlng.lat},${e.latlng.lng}')">COMO LLEGAR</button>
            <button class="btn-ws" onclick="window.open('https://wa.me/?text=${ws}')">WHATSAPP</button>
        </div>
    `).openOn(mymap);
});

// Buscador
document.getElementById('search-btn').addEventListener('click', () => {
    const code = document.getElementById('search-input').value.trim().toUpperCase();
    if (!code || !rawCuadricula) return;
    const parts = code.split('-');
    let f = rawCuadricula.features.find(feat => feat.properties.codigo === parts[0]);
    if (f) {
        const b = L.geoJSON(f).getBounds();
        mymap.fitBounds(b);
    }
});

// Localizaci√≥n
mymap.on('locationfound', e => {
    userLocationLayer.clearLayers();
    L.circleMarker(e.latlng, { radius: 6, color: '#fff', fillColor: '#1a73e8', fillOpacity: 1, weight: 2 }).addTo(userLocationLayer);
});

const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const b = L.DomUtil.create('a', 'locate-button', c);
        b.innerHTML = 'üéØ';
        L.DomEvent.on(b, 'click', e => { L.DomEvent.stopPropagation(e); mymap.locate({setView:true, maxZoom:17}); });
        return c;
    }
});
mymap.addControl(new LocateControl());

L.control.layers(null, {
    "Zonas": zonasGeoLayer,
    "Macro": cuadriculaLayer,
    "Rutas": rutasLayer,
    "Estafetas": estafetasPointsLayer,
    "Rejilla": gridLayer
}, {collapsed: false}).addTo(mymap);

</script>
</body>
</html>
