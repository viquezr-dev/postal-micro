<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM츼 - FUSI칍N PRO</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; font-weight: bold; text-shadow: 0 0 5px white; }
        
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 260px; }
        input#search-input { flex: 1; border: none; padding: 8px; font-size: 14px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }

        .toggle-watermark { position: absolute; bottom: 30px; left: 10px; z-index: 5000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; font-weight: bold; font-size: 11px; border: 1px solid #1a73e8; color: #1a73e8; }
        .toggle-watermark.off { color: #666; border-color: #ccc; }

        .grid-label { font-size: 10px; font-weight: bold; color: #1a73e8; pointer-events: none; text-shadow: 0 0 2px white; text-align: center; line-height: 1; }
        .btn-nav, .btn-ws { display: inline-block; margin-top: 8px; padding: 8px 12px; color: white !important; text-decoration: none !important; border-radius: 5px; font-weight: bold; font-size: 11px; border:none; cursor:pointer; }
        .btn-nav { background-color: #3498db; margin-right: 5px; }
        .btn-ws { background-color: #25D366; }
        .locate-button { background: white; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 5px; font-size: 18px; border: 2px solid rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM츼</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: J4199">
    <button id="search-btn">IR</button>
</div>
<div id="toggle-wm" class="toggle-watermark">TEXTO: ON</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid', { zoomControl: true }).setView([8.50, -80.0], 7.8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// Capas
const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);
const zonasGeoLayer = L.layerGroup().addTo(mymap);
const cuadriculaLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
let rawZonas = null;
let labelsEnabled = true;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";

// --- L칍GICA DE PRECISI칍N MATEM츼TICA ---
// Se asume que cada cuadro macro de tu GeoJSON mide aprox estas dimensiones:
const MACRO_LAT_SIZE = 0.083333; // Ajuste para que 24 unidades encajen
const MACRO_LON_SIZE = 0.083333;

function updateGrid() {
    gridLayer.clearLayers();
    labelLayer.clearLayers();
    
    const zoom = mymap.getZoom();
    if (!rawCuadricula || zoom < 14) return;

    const b = mymap.getBounds();
    
    // Solo dibujamos si la rejilla din치mica est치 activa en el control de capas
    if (!mymap.hasLayer(gridLayer)) return;

    rawCuadricula.features.forEach(f => {
        const featBounds = L.geoJSON(f).getBounds();
        if (!b.intersects(featBounds)) return;

        const sw = featBounds.getSouthWest();
        const ne = featBounds.getNorthEast();
        const macroCode = f.properties.codigo;

        // Tama침o de cada celda Micro (1/24 del Macro)
        const sX = (ne.lng - sw.lng) / 24;
        const sY = (ne.lat - sw.lat) / 24;

        // Iteramos con la l칩gica de Math.floor para asegurar alineaci칩n perfecta
        for (let i = 0; i < 24; i++) {
            for (let j = 0; j < 24; j++) {
                // C치lculo de coordenadas fijas
                const x1 = sw.lng + (i * sX);
                const y1 = sw.lat + (j * sY);
                const x2 = sw.lng + ((i + 1) * sX);
                const y2 = sw.lat + ((j + 1) * sY);
                
                const rectBounds = L.latLngBounds([y1, x1], [y2, x2]);

                if (b.intersects(rectBounds)) {
                    // Dibujo de celda sin traslape (usando el mismo borde para el vecino)
                    L.rectangle(rectBounds, {
                        color: "#1a73e8",
                        weight: 0.5,
                        fillOpacity: 0.02,
                        interactive: false
                    }).addTo(gridLayer);

                    // Etiquetas Watermark
                    if (labelsEnabled && zoom >= 15 && zoom < 18 && mymap.hasLayer(cuadriculaLayer)) {
                        const microC = `${ALFABETO[i]}${ALFABETO[j]}${i % 10}${j % 10}${Math.floor((i + j) / 5)}`;
                        L.marker(rectBounds.getCenter(), {
                            icon: L.divIcon({
                                className: 'grid-label',
                                html: `<div>${macroCode}</div><div>${microC}</div>`,
                                iconSize: [50, 25]
                            }),
                            interactive: false
                        }).addTo(labelLayer);
                    }
                }
            }
        }
    });
}

// --- CARGA DE DATOS ---
$.getJSON("estafetas.geojson", d => { rawZonas = d; L.geoJSON(d, {style:{color:"#000", weight:1.5, fillOpacity:0.1}}).addTo(zonasGeoLayer); });
$.getJSON("cuadricula.geojson", d => { 
    rawCuadricula = d; 
    L.geoJSON(d, {style:{color:"#2c3e50", weight:1, fillOpacity:0.05}}).addTo(cuadriculaLayer);
    updateGrid(); 
});
$.getJSON("estafetasl.geojson", d => L.geoJSON(d, {style:{color:"#e74c3c", weight:2}}).addTo(rutasLayer));
$.getJSON("estafetasp.geojson", d => L.geoJSON(d, {pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:6, color:"#27ae60", fillColor:"#2ecc71", fillOpacity:1})}).addTo(estafetasPointsLayer));

// --- INTERACCI칍N ---
mymap.on('moveend zoomend overlayadd overlayremove', updateGrid);

$('#toggle-wm').click(function() {
    labelsEnabled = !labelsEnabled;
    $(this).toggleClass('off').text(labelsEnabled ? "TEXTO: ON" : "TEXTO: OFF");
    updateGrid();
});

mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    if (!rawCuadricula) return;

    const hit = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawCuadricula));
    if (hit.length === 0) return;

    const f = hit[0].feature;
    const b = f.geometry.coordinates[0];
    const lats = b.map(c => c[1]), lngs = b.map(c => c[0]);
    const minLat = Math.min(...lats), minLng = Math.min(...lngs);
    const maxLat = Math.max(...lats), maxLng = Math.max(...lngs);

    const sX = (maxLng - minLng) / 24, sY = (maxLat - minLat) / 24;
    const ix = Math.floor((e.latlng.lng - minLng) / sX);
    const iy = Math.floor((e.latlng.lat - minLat) / sY);

    const micro = `${ALFABETO[ix]}${ALFABETO[iy]}${ix % 10}${iy % 10}${Math.floor((ix + iy) / 5)}`;
    const finalCode = `${f.properties.codigo}-${micro}`;

    const ws = encodeURIComponent(`游늸 Mi ubicaci칩n: ${finalCode}\nGPS: ${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`);
    
    L.popup()
        .setLatLng(e.latlng)
        .setContent(`
            <div style="text-align:center;">
                <small>DIRECCI칍N POSTAL</small><br>
                <b>${finalCode}</b><br>
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">游늸 IR</button>
                <button class="btn-ws" onclick="window.open('https://wa.me/?text=${ws}')">游눫 WS</button>
            </div>
        `).openOn(mymap);
});

L.control.layers(null, {
    "Zonas": zonasGeoLayer,
    "Cuadr칤cula": cuadriculaLayer,
    "Rutas": rutasLayer,
    "Estafetas": estafetasPointsLayer,
    "Rejilla Din치mica": gridLayer
}, {collapsed: false}).addTo(mymap);
</script>
</body>
</html>
