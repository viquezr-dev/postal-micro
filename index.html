<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM츼 - PRECISI칍N MICRO</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        
        .map-title {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 4000; text-align: center; pointer-events: none; width: 90%;
        }
        .map-title h1 { 
            margin: 0; font-size: 22px; color: #2c3e50; font-weight: bold; letter-spacing: 2px;
            text-shadow: 0 0 5px white, 0 0 10px white;
        }

        /* Buscador */
        .search-container {
            position: absolute; top: 10px; right: 10px; z-index: 3000;
            display: flex; background: white; padding: 5px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px;
        }
        input#search-input { flex: 1; border: none; padding: 8px; font-size: 14px; outline: none; width: 100%; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Popups y Botones */
        .btn-nav {
            display: inline-block; margin-top: 10px; padding: 8px 15px;
            background-color: #3498db; color: white !important; text-decoration: none !important;
            border-radius: 5px; font-weight: bold; font-size: 12px;
        }
        .code-display { font-size: 20px; font-weight: bold; color: #e67e22; margin: 5px 0; display: block; }

        @media only screen and (max-width: 600px) {
            .map-title h1 { font-size: 14px; }
            .search-container { width: 200px; top: 50px; right: 50%; transform: translateX(50%); }
        }

        .leaflet-top.leaflet-right { top: 65px !important; }
        .locate-button { background: white; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 5px; font-size: 18px; border: 2px solid rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="map-title">
    <h1>SISTEMA POSTAL DE PANAM츼</h1>
</div>

<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: M8599-BK502">
    <button id="search-btn">IR</button>
</div>

<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
// --- CONFIGURACI칍N DE MAPA ---
const mymap = L.map('mapid', { zoomControl: true }).setView([8.98, -79.52], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(mymap);

let macroLayer = L.layerGroup().addTo(mymap);
let estafetaslLayer = L.layerGroup().addTo(mymap);
let estafetaspLayer = L.layerGroup().addTo(mymap);
let rawMacroData = null; // Aqu칤 guardamos el GeoJSON de la cuadr칤cula

// --- L칍GICA DE NAVEGACI칍N ---
function abrirNavegacion(lat, lon) {
    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
    window.open(url, '_blank');
}

// --- GENERADOR DE C칍DIGO MICRO (LLNNN) ---
function generarMicroCodigo(lat, lon, bounds) {
    const ALFABETO = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const sw = bounds.getSouthWest();
    const ne = bounds.getNorthEast();
    
    // Normalizar posici칩n dentro del cuadro (0 a 1)
    let xNorm = (lon - sw.lng) / (ne.lng - sw.lng);
    let yNorm = (lat - sw.lat) / (ne.lat - sw.lat);
    
    xNorm = Math.max(0, Math.min(0.9999, xNorm));
    yNorm = Math.max(0, Math.min(0.9999, yNorm));

    // 2 Letras: X determina la primera, Y la segunda
    let l1 = ALFABETO[Math.floor(xNorm * 26)];
    let l2 = ALFABETO[Math.floor(yNorm * 26)];

    // 3 N칰meros: Combinaci칩n de alta precisi칩n
    let n1 = Math.floor(((xNorm * 26) % 1) * 10);
    let n2 = Math.floor(((yNorm * 26) % 1) * 10);
    let n3 = Math.floor((((xNorm + yNorm) * 260) % 1) * 10);

    return `${l1}${l2}${n1}${n2}${n3}`;
}

// --- CARGA DE DATOS ---

// 1. CARGAR TU CUADRICULA (Macro-GeoJSON)
$.getJSON("cuadricula.geojson", function(data) {
    rawMacroData = data;
    L.geoJSON(data, {
        style: { color: "#2c3e50", weight: 1, fillOpacity: 0.05 }
    }).addTo(macroLayer);
});

// 2. L칤neas y Estafetas (Tus capas adicionales)
$.getJSON("estafetasl.geojson", function(data) {
    L.geoJSON(data, { style: { color: "#e74c3c", weight: 2 } }).addTo(estafetaslLayer);
});

$.getJSON("estafetasp.geojson", function(data) {
    L.geoJSON(data, {
        pointToLayer: (f, ll) => L.circleMarker(ll, {radius:6, color:"#27ae60", fillColor:"#2ecc71", fillOpacity:1}),
        onEachFeature: (f, l) => {
            let n = f.properties.ESTAF_NAME || "Estafeta";
            l.bindPopup(`<b>ESTAFETA:</b><br>${n}<br><button class="btn-nav" onclick="abrirNavegacion(${l.getLatLng().lat}, ${l.getLatLng().lng})">游늸 IR</button>`);
        }
    }).addTo(estafetaspLayer);
});

// --- CLIC EN EL MAPA ---
mymap.on("click", function (e) {
    let macroID = "ZONA EXTERIOR";
    let microID = "00000";

    if (rawMacroData) {
        // Buscamos el pol칤gono de la cuadr칤cula que contiene el clic
        const hit = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawMacroData));
        
        if (hit.length > 0) {
            // USAMOS LA PROPIEDAD DE TU GEOJSON (Ajustar si se llama diferente a 'ID')
            macroID = hit[0].feature.properties.ID || hit[0].feature.properties.CODIGO || "AREA";
            
            // Calculamos l칤mites del cuadro actual para la precisi칩n micro
            const tempLayer = L.geoJSON(hit[0].feature);
            microID = generarMicroCodigo(e.latlng.lat, e.latlng.lng, tempLayer.getBounds());
        }
    }

    const fullCode = `${macroID}-${microID}`;

    L.popup()
        .setLatLng(e.latlng)
        .setContent(`
            <div style="text-align:center;">
                <small>C칍DIGO POSTAL DIN츼MICO</small><br>
                <span class="code-display">${fullCode}</span><br>
                <a href="#" class="btn-nav" onclick="abrirNavegacion(${e.latlng.lat}, ${e.latlng.lng})">游늸 NAVEGAR AQU칈</a>
            </div>
        `).openOn(mymap);
});

// --- BOT칍N GPS ---
const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', 'locate-button', container);
        button.innerHTML = '游꿢';
        L.DomEvent.on(button, 'click', e => { 
            L.DomEvent.stopPropagation(e); 
            mymap.locate({setView: true, maxZoom: 18}); 
        });
        return container;
    }
});
mymap.addControl(new LocateControl());

// --- BUSCADOR (B치sico por coordenadas o podr칤as ampliarlo) ---
document.getElementById('search-btn').onclick = function() {
    const query = document.getElementById('search-input').value.trim();
    if(query === "") return;
    alert("Buscando ubicaci칩n para: " + query + "\n(Implementar l칩gica de b칰squeda inversa si es necesario)");
};

// Control de Capas
const overlayMaps = {
    "Cuadr칤cula Macro": macroLayer,
    "Rutas": estafetaslLayer,
    "Estafetas": estafetaspLayer
};
L.control.layers(null, overlayMaps, {collapsed: true}).addTo(mymap);

</script>
</body>
</html>
