<!DOCTYPE html>
<html>
<head>
<title>SISTEMA POSTAL DE PANAMÁ</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

<style>
html, body, #mapid { height:100%; margin:0; }

.watermark-label-fixed{
    background:none!important;
    border:none!important;
    color:#1a73e8;
    font-size:11px;
    text-align:center;
    pointer-events:none;
    text-shadow:1px 1px 2px white;
}
</style>
</head>

<body>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
/* =========================
   MAPA
========================= */
const map = L.map('mapid').setView([8.5, -80], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

map.createPane('labels');
map.getPane('labels').style.pointerEvents = 'none';

/* =========================
   CAPAS
========================= */
const gridLayer = L.layerGroup().addTo(map);
const labelLayer = L.layerGroup().addTo(map);
const selectionLayer = L.layerGroup().addTo(map);
const cuadriculaLayer = L.layerGroup().addTo(map);

let rawCuadricula = null;

/* =========================
   CONSTANTES EN METROS (CLAVE)
========================= */

/* Origen global WebMercator */
const ORIGIN = -20037508.342789244;

/* Sistema postal */
const MACRO_SIZE = 10000;        // 10 km
const MICRO_DIV  = 24;
const NANO_DIV   = 10;

const MICRO_SIZE = MACRO_SIZE / MICRO_DIV;          // 416.6667 m
const NANO_SIZE  = MICRO_SIZE / NANO_DIV;           // 41.66667 m

/* =========================
   DIBUJO REJILLA NANO (GLOBAL)
========================= */
function updateNanoGrid(){
    gridLayer.clearLayers();

    if (!rawCuadricula) return;
    const z = map.getZoom();
    if (z < 17) return;

    const bounds = map.getBounds();

    const pSW = L.CRS.EPSG3857.project(bounds.getSouthWest());
    const pNE = L.CRS.EPSG3857.project(bounds.getNorthEast());

    const minX = Math.floor((pSW.x - ORIGIN) / NANO_SIZE);
    const maxX = Math.floor((pNE.x - ORIGIN) / NANO_SIZE);
    const minY = Math.floor((pSW.y - ORIGIN) / NANO_SIZE);
    const maxY = Math.floor((pNE.y - ORIGIN) / NANO_SIZE);

    rawCuadricula.features.forEach(f => {
        const macroBounds = L.geoJSON(f).getBounds();
        if (!bounds.intersects(macroBounds)) return;

        for (let x = minX; x <= maxX; x++) {
            for (let y = minY; y <= maxY; y++) {

                const x0 = ORIGIN + x * NANO_SIZE;
                const y0 = ORIGIN + y * NANO_SIZE;

                const llSW = L.CRS.EPSG3857.unproject(L.point(x0, y0));
                const llNE = L.CRS.EPSG3857.unproject(L.point(x0 + NANO_SIZE, y0 + NANO_SIZE));

                const nanoBounds = L.latLngBounds(llSW, llNE);
                if (!macroBounds.intersects(nanoBounds)) continue;

                L.rectangle(nanoBounds,{
                    color:"#e67e22",
                    weight:0.3,
                    opacity:0.7,
                    fillOpacity:0.05,
                    interactive:false
                }).addTo(gridLayer);
            }
        }
    });
}


/* =========================
   CLICK (FUNCIONAL)
========================= */
map.on("click", e => {
    selectionLayer.clearLayers();
    if (!rawCuadricula) return;

    const hit = leafletPip.pointInLayer(
        [e.latlng.lng, e.latlng.lat],
        L.geoJSON(rawCuadricula)
    );

    if (!hit.length){
        L.popup().setLatLng(e.latlng)
        .setContent("<b>Área no válida</b>")
        .openOn(map);
        return;
    }

    const macro = hit[0].feature;
    const macroCode = macro.properties.codigo;

    const p = map.project(e.latlng, map.getMaxZoom());
    const nx = Math.floor((p.x - ORIGIN) / NANO_SIZE);
    const ny = Math.floor((p.y - ORIGIN) / NANO_SIZE);

    const x0 = ORIGIN + nx * NANO_SIZE;
    const y0 = ORIGIN + ny * NANO_SIZE;

    const llSW = map.unproject(L.point(x0, y0), map.getMaxZoom());
    const llNE = map.unproject(L.point(x0 + NANO_SIZE, y0 + NANO_SIZE), map.getMaxZoom());

    const nanoRect = L.latLngBounds(llSW, llNE);

    L.rectangle(nanoRect,{
        color:"#e67e22",
        weight:4,
        fillOpacity:0.3
    }).addTo(selectionLayer);

    const finalCode = `${macroCode}-H${nx}${ny}`;

    L.popup()
      .setLatLng(e.latlng)
      .setContent(`<small>CÓDIGO POSTAL</small><br><b>${finalCode}</b>`)
      .openOn(map);
});

/* =========================
   CARGA GEOJSON
========================= */
$.getJSON("cuadricula.geojson", d => {
    rawCuadricula = d;
    L.geoJSON(d,{
        style:{color:"#2c3e50",weight:1,fillOpacity:0.05}
    }).addTo(cuadriculaLayer);
    updateNanoGrid();
});

map.on("moveend zoomend", updateNanoGrid);

/* =========================
   CONTROL DE CAPAS
========================= */
L.control.layers(null,{
    "Cuadrícula Macro": cuadriculaLayer,
    "Rejilla Nano": gridLayer
},{collapsed:false}).addTo(map);

</script>
</body>
</html>

