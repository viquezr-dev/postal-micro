<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAM츼</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        .leaflet-popup { margin-bottom: 70px !important; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; font-weight: bold; text-shadow: 0 0 5px white; }
        
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 280px; }
        input#search-input { flex: 1; border: none; padding: 8px; font-size: 14px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        .leaflet-top.leaflet-right { top: 85px !important; }

        /* ESTILO MARCA DE AGUA MEJORADO */
        .watermark-label-fixed {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            color: rgba(44, 62, 80, 0.35) !important; /* Color oscuro tenue */
            font-size: 14px !important;
            font-weight: 900 !important;
            text-align: center;
            pointer-events: none !important;
            white-space: nowrap;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }

        .btn-nav, .btn-ws { display: inline-block; margin-top: 8px; padding: 8px 12px; color: white !important; text-decoration: none !important; border-radius: 5px; font-weight: bold; font-size: 11px; border:none; cursor:pointer; }
        .btn-nav { background-color: #3498db; margin-right: 5px; }
        .btn-ws { background-color: #25D366; }
        .locate-button { background: white; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 5px; font-size: 18px; border: 2px solid rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAM츼</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: J4199">
    <button id="search-btn">IR</button>
</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid', { zoomControl: true }).setView([7.6, -80.3], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

// Crear un Pane especial para las etiquetas para que no bloqueen clics
mymap.createPane('watermarkPane');
mymap.getPane('watermarkPane').style.zIndex = 600;
mymap.getPane('watermarkPane').style.pointerEvents = 'none';

const gridLayer = L.layerGroup();
const labelLayer = L.layerGroup().addTo(mymap); 
const selectionLayer = L.layerGroup().addTo(mymap);
const zonasGeoLayer = L.layerGroup().addTo(mymap); 
const cuadriculaLayer = L.layerGroup().addTo(mymap);
const rutasLayer = L.layerGroup().addTo(mymap);
const estafetasPointsLayer = L.layerGroup().addTo(mymap);
const userLocationLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
let rawZonas = null;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ"; 

// --- FUNCI칍N DE MARCA DE AGUA (Actualizada para tu JSON) ---
function updateLabels() {
    labelLayer.clearLayers();
    const z = mymap.getZoom();
    
    // Solo mostrar marcas de agua entre zoom 10 y 16
    if (z < 10 || z > 16 || !rawCuadricula) return;

    const bounds = mymap.getBounds();
    rawCuadricula.features.forEach(f => {
        // Creamos un layer temporal para obtener el centro
        const tempLayer = L.geoJSON(f);
        const center = tempLayer.getBounds().getCenter();
        
        // Solo dibujar si el cuadro est치 visible en pantalla
        if (bounds.contains(center)) {
            L.marker(center, {
                pane: 'watermarkPane',
                icon: L.divIcon({
                    className: 'watermark-label-fixed',
                    html: `<div>${f.properties.codigo}</div>`,
                    iconSize: [80, 20]
                }),
                interactive: false
            }).addTo(labelLayer);
        }
    });
}

// L칩gica de jerarqu칤a (Micro y Nano)
function getHierarchicalData(lat, lon, macroBounds) {
    const sw = macroBounds.getSouthWest();
    const ne = macroBounds.getNorthEast();
    const stepX = (ne.lng - sw.lng) / 24;
    const stepY = (ne.lat - sw.lat) / 24;
    const ix = Math.max(0, Math.min(23, Math.floor((lon - sw.lng) / stepX)));
    const iy = Math.max(0, Math.min(23, Math.floor((lat - sw.lat) / stepY)));
    return {
        micro: `${ALFABETO[ix]}${ALFABETO[iy]}${ix % 10}${iy % 10}${Math.floor((ix + iy) / 5)}`,
        nano: `${ALFABETO[(Math.max(0, Math.min(9, Math.floor((lon - (sw.lng + (ix * stepX))) / (stepX / 10)))) * 7 + Math.max(0, Math.min(9, Math.floor((lat - (sw.lat + (iy * stepY))) / (stepY / 10)))) * 13) % 24]}${Math.max(0, Math.min(9, Math.floor((lat - (sw.lat + (iy * stepY))) / (stepY / 10))))}`,
        microRect: [[sw.lat + (iy * stepY), sw.lng + (ix * stepX)], [sw.lat + ((iy + 1) * stepY), sw.lng + ((ix + 1) * stepX)]],
        nanoRect: [[sw.lat + (iy * stepY) + (Math.max(0, Math.min(9, Math.floor((lat - (sw.lat + (iy * stepY))) / (stepY / 10)))) * (stepY / 10)), sw.lng + (ix * stepX) + (Math.max(0, Math.min(9, Math.floor((lon - (sw.lng + (ix * stepX))) / (stepX / 10)))) * (stepX / 10))], [sw.lat + (iy * stepY) + ((Math.max(0, Math.min(9, Math.floor((lat - (sw.lat + (iy * stepY))) / (stepY / 10)))) + 1) * (stepY / 10)), sw.lng + (ix * stepX) + ((Math.max(0, Math.min(9, Math.floor((lon - (sw.lng + (ix * stepX))) / (stepX / 10)))) + 1) * (stepX / 10))]]
    };
}

function updateGrid() {
    gridLayer.clearLayers();
    if (mymap.getZoom() < 16 || !rawCuadricula || !mymap.hasLayer(gridLayer)) return;
    const b = mymap.getBounds();
    const hit = leafletPip.pointInLayer([b.getCenter().lng, b.getCenter().lat], L.geoJSON(rawCuadricula));
    if (hit.length > 0) {
        const mB = L.geoJSON(hit[0].feature).getBounds();
        const sX = (mB.getEast() - mB.getWest()) / 24, sY = (mB.getNorth() - mB.getSouth()) / 24;
        for (let i=0; i<24; i++) for (let j=0; j<24; j++) {
            let s = mB.getSouth()+(j*sY), w = mB.getWest()+(i*sX);
            if (b.intersects([[s, w], [s+sY, w+sX]])) L.rectangle([[s, w], [s+sY, w+sX]], {color: "#3498db", weight: 0.5, fillOpacity: 0.05, interactive: false}).addTo(gridLayer);
        }
    }
}

// Eventos de mapa
mymap.on('moveend zoomend', () => { updateLabels(); updateGrid(); });

// Carga de datos
$.getJSON("estafetas.geojson", d => { rawZonas = d; L.geoJSON(d, {style:{color:"#000", weight:1.5, fillOpacity:0.1, fillColor:"#888"}}).addTo(zonasGeoLayer); });
$.getJSON("cuadricula.geojson", d => { 
    rawCuadricula = d; 
    L.geoJSON(d, {style:{color:"#2c3e50", weight:1, fillOpacity:0.05}}).addTo(cuadriculaLayer); 
    updateLabels(); 
});
$.getJSON("estafetasl.geojson", d => L.geoJSON(d, {style:{color:"#e74c3c", weight:2}}).addTo(rutasLayer));
$.getJSON("estafetasp.geojson", d => L.geoJSON(d, {pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:6, color:"#27ae60", fillColor:"#2ecc71", fillOpacity:1})}).addTo(estafetasPointsLayer));

// Click en el mapa
mymap.on("click", function (e) {
    selectionLayer.clearLayers();
    if (!rawCuadricula || !rawZonas) return;
    const hZ = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawZonas));
    const hC = leafletPip.pointInLayer([e.latlng.lng, e.latlng.lat], L.geoJSON(rawCuadricula));
    if (hC.length === 0) return;

    const useZonas = mymap.hasLayer(zonasGeoLayer) && hZ.length > 0;
    const macroID = useZonas ? hZ[0].feature.properties.VM_LEVEL : hC[0].feature.properties.codigo;
    const mBounds = L.geoJSON(hC[0].feature).getBounds();
    const data = getHierarchicalData(e.latlng.lat, e.latlng.lng, mBounds);
    
    let titulo = "ZONAS POSTALES", finalCode = macroID;
    const z = mymap.getZoom();

    if (z < 14) {
        L.geoJSON(useZonas ? hZ[0].feature : hC[0].feature, {style:{color:"#2c3e50", weight:4, fillOpacity:0.3}}).addTo(selectionLayer);
    }
    if (z >= 14) {
        titulo = (z >= 17) ? "C칍DIGO POSTAL" : "츼REA POSTAL";
        finalCode += `-${data.micro}`;
        if (z < 17) L.rectangle(data.microRect, {color:"#3498db", weight:4, fillOpacity:0.2}).addTo(selectionLayer);
    }
    if (z >= 17) {
        finalCode += `-${data.nano}`;
        L.rectangle(data.nanoRect, {color:"#e67e22", weight:5, fillOpacity:0.4}).addTo(selectionLayer);
    }

    const ws = encodeURIComponent(`游늸 Mi ubicaci칩n Postal: ${finalCode}\nGPS: ${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`);
    L.popup({offset:[0,-55]}).setLatLng(e.latlng).setContent(`<div style="text-align:center;"><small style="color:#7f8c8d; font-weight:bold;">${titulo}</small><br><span style="font-size:16px; font-weight:bold;">${finalCode}</span><br><button class="btn-nav" onclick="window.open('https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}')">游늸 MAPS</button><button class="btn-ws" onclick="window.open('https://wa.me/?text=${ws}')">游눫 WS</button></div>`).openOn(mymap);
});

// Buscador
document.getElementById('search-btn').addEventListener('click', () => {
    const code = document.getElementById('search-input').value.trim().toUpperCase();
    if (!code || !rawCuadricula) return;
    const parts = code.split('-');
    let f = rawCuadricula.features.find(feat => feat.properties.codigo === parts[0]);
    if (f) {
        const b = L.geoJSON(f).getBounds();
        if (parts[1] && parts[1].length >= 5) {
            const ix = ALFABETO.indexOf(parts[1][0]), iy = ALFABETO.indexOf(parts[1][1]);
            const sX = (b.getEast()-b.getWest())/24, sY = (b.getNorth()-b.getSouth())/24;
            const lat = b.getSouth()+(iy*sY)+(sY/2), lon = b.getWest()+(ix*sX)+(sX/2);
            mymap.setView([lat, lon], 18);
            setTimeout(() => mymap.fire('click', {latlng: L.latLng(lat, lon)}), 600);
        } else { mymap.fitBounds(b); }
    }
});

mymap.on('locationfound', function(e) {
    userLocationLayer.clearLayers();
    L.circleMarker(e.latlng, { radius: 7, color: 'white', fillColor: '#3498db', fillOpacity: 1, weight: 2 }).addTo(userLocationLayer);
});

const LocateControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
        const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const b = L.DomUtil.create('a', 'locate-button', c);
        b.innerHTML = '游꿢';
        L.DomEvent.on(b, 'click', e => { L.DomEvent.stopPropagation(e); mymap.locate({setView:true, maxZoom:17}); });
        return c;
    }
});
mymap.addControl(new LocateControl());

L.control.layers(null, {
    "Pol칤gonos Zonas (Gris)": zonasGeoLayer,
    "Cuadr칤cula Macro": cuadriculaLayer,
    "Rutas Postales": rutasLayer,
    "Estafetas (Puntos)": estafetasPointsLayer,
    "Rejilla Din치mica": gridLayer
}, {collapsed: false}).addTo(mymap);
</script>
</body>
</html>
