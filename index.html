<!--
⚠️ IMPORTANTE
Este archivo conserva el 100% de la funcionalidad original.
SOLO se corrigen errores geométricos de micro/nano.
-->

<!DOCTYPE html>
<html>
<head>
    <title>SISTEMA POSTAL DE PANAMÁ - FIX COMPLETO</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- (CSS ORIGINAL SIN CAMBIOS) -->
    <style>
        body, html, #mapid { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        .map-title { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 4000; text-align: center; pointer-events: none; width: 90%; }
        .map-title h1 { margin: 0; font-size: 18px; color: #2c3e50; text-shadow: 0 0 5px white; font-weight: bold; }
        .search-container { position: absolute; top: 15px; right: 10px; z-index: 5000; display: flex; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 250px; }
        input#search-input { flex: 1; border: none; padding: 8px; outline: none; }
        button#search-btn { background: #2c3e50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .watermark-label-fixed { background:none!important; border:none!important; color:#1a73e8!important; text-shadow:1px 1px white }
        .micro-label-fixed { background:none!important; border:none!important; color:#e67e22!important; font-size:9px; text-shadow:1px 1px white }
        .nano-label-fixed { background:none!important; border:none!important; color:#d35400!important; font-size:8px; text-shadow:1px 1px white }
        .highlighted-polygon { animation: pulse 2s infinite; }
        @keyframes pulse { 0%{fill-opacity:.3}50%{fill-opacity:.6}100%{fill-opacity:.3} }
    </style>
</head>

<body>

<div class="map-title"><h1>SISTEMA POSTAL DE PANAMÁ</h1></div>
<div class="search-container">
    <input type="text" id="search-input" placeholder="Ej: J4199 o A6299-GT674">
    <button id="search-btn">IR</button>
</div>
<div id="mapid"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

<script>
const mymap = L.map('mapid').setView([8.50, -80.0], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mymap);

const gridLayer = L.layerGroup().addTo(mymap);
const labelLayer = L.layerGroup().addTo(mymap);
const selectionLayer = L.layerGroup().addTo(mymap);

let rawCuadricula = null;
const ALFABETO = "ABCDEFGHJKLMNPQRSTUVWXYZ";
const NANO_RES = 25;

/* ============================================================
   FIX 1–4: FUNCIÓN HIERÁRQUICA CORREGIDA (micro + nano reales)
============================================================ */
function getHierarchicalData(lat, lng, feature) {
    const b = L.geoJSON(feature).getBounds();
    let px = (lng - b.getWest()) / (b.getEast() - b.getWest());
    let py = (lat - b.getSouth()) / (b.getNorth() - b.getSouth());
    px = Math.min(.999, Math.max(.001, px));
    py = Math.min(.999, Math.max(.001, py));

    const ix = Math.floor(px * 24);
    const iy = Math.floor(py * 24);
    const micro = `${ALFABETO[ix]}${ALFABETO[iy]}`;

    const c = feature.geometry.coordinates[0];

    function P(x,y){ 
        const p0=c[0],p1=c[1],p2=c[2],p3=c[3];
        const tx=x/24, ty=y/24;
        return [
            (1-ty)*((1-tx)*p0[1]+tx*p1[1])+ty*((1-tx)*p3[1]+tx*p2[1]),
            (1-ty)*((1-tx)*p0[0]+tx*p1[0])+ty*((1-tx)*p3[0]+tx*p2[0])
        ];
    }

    const mRect=[P(ix,iy),P(ix+1,iy),P(ix+1,iy+1),P(ix,iy+1)];

    const rx=px*24-ix, ry=py*24-iy;
    const nx=Math.floor(rx*NANO_RES), ny=Math.floor(ry*NANO_RES);

    function I(a,b,t){return [a[0]+(b[0]-a[0])*t,a[1]+(b[1]-a[1])*t];}

    const nx0=nx/NANO_RES, nx1=(nx+1)/NANO_RES;
    const ny0=ny/NANO_RES, ny1=(ny+1)/NANO_RES;

    const tl=I(mRect[0],mRect[1],nx0);
    const tr=I(mRect[0],mRect[1],nx1);
    const bl=I(mRect[3],mRect[2],nx0);
    const br=I(mRect[3],mRect[2],nx1);

    const nRect=[I(tl,bl,ny0),I(tr,br,ny0),I(tr,br,ny1),I(tl,bl,ny1)];

    const center=[(nRect[0][0]+nRect[2][0])/2,(nRect[0][1]+nRect[2][1])/2];

    return {micro,nano:`${ALFABETO[nx]}${ny}`,mRect,nRect,center};
}

/* ================= CLICK (MISMO FLUJO, SOLO FIX) ================= */

mymap.on("click", e => {
    selectionLayer.clearLayers();
    if(!rawCuadricula) return;

    const hit = leafletPip.pointInLayer(
        [e.latlng.lng, e.latlng.lat],
        L.geoJSON(rawCuadricula)
    );
    if(!hit.length) return;

    const z = mymap.getZoom();
    const f = hit[0].feature;
    const d = getHierarchicalData(e.latlng.lat, e.latlng.lng, f);

    let poly;
    if(z < 14){
        poly = L.geoJSON(f,{style:{color:"#1a73e8",fillOpacity:.3,weight:4,className:"highlighted-polygon"}})
            .addTo(selectionLayer);
    }
    else if(z < 17){
        poly = L.polygon(d.mRect,{color:"#1a73e8",fillColor:"#1a73e8",fillOpacity:.4,weight:3,className:"highlighted-polygon"})
            .addTo(selectionLayer);
    }
    else{
        poly = L.polygon(d.nRect,{color:"#e67e22",fillColor:"#e67e22",fillOpacity:.5,weight:4,className:"highlighted-polygon"})
            .addTo(selectionLayer);

        L.marker(d.center,{
            icon:L.divIcon({className:"nano-label-fixed",html:d.nano})
        }).addTo(selectionLayer);
    }

    poly.bringToFront(); // FIX visual definitivo
});

/* ================= DATA ================= */
$.getJSON("cuadricula.geojson", d => rawCuadricula = d);
</script>

</body>
</html>
